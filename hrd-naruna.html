<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Naruna Payroll - V8 (Production Candidate)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script>
        tailwind.config = { theme: { extend: { colors: { primary: '#0f172a', secondary: '#3b82f6' }, fontFamily: { sans: ['Inter'] } } } }
    </script>

    <style>
        body { background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .custom-scroll::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* Render Container - Fixed Width */
        .payslip-container { 
            width: 800px; 
            background: white; 
            font-family: Arial, Helvetica, sans-serif;
            color: #000;
            line-height: 1.3;
        }
        
        #render-area { position: fixed; top: 0; left: 0; z-index: -50; opacity: 0; pointer-events: none; }
        
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); z-index: 100; justify-content: center; align-items: center; color: white; flex-direction: column; backdrop-filter: blur(4px); }
        
        #debug-console { position: fixed; bottom: 0; left: 0; width: 100%; background: #1e293b; color: #cbd5e1; font-family: monospace; z-index: 50; transition: transform 0.3s ease; transform: translateY(100%); max-height: 40vh; display: flex; flex-direction: column; border-top-left-radius: 12px; border-top-right-radius: 12px; }
        #debug-console.open { transform: translateY(0); }
        
        .kop-item { border: 2px solid transparent; transition: all 0.2s; }
        .kop-item.active { border-color: #3b82f6; background-color: #eff6ff; ring: 2px solid #93c5fd; }
        
        .badge-ssot { background: #dcfce7; color: #166534; border: 1px solid #86efac; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .badge-diff { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }
    </style>
</head>
<body class="text-slate-800">

    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mb-4"></div>
        <h2 id="loading-text" class="text-lg font-semibold tracking-wide">Memproses...</h2>
    </div>

    <div id="login-section" class="min-h-screen flex items-center justify-center p-4 bg-slate-900">
        <div class="bg-white p-8 rounded-2xl w-full max-w-md shadow-2xl border-t-4 border-blue-600">
            <div class="text-center mb-8">
                <i class="fas fa-money-check-alt text-4xl text-blue-600 mb-2"></i>
                <h2 class="text-2xl font-bold text-slate-800">Naruna Payroll V8</h2>
                <p class="text-slate-500 text-sm font-mono mt-1">PRODUCTION READY</p>
            </div>
            <form onsubmit="handleLogin(event)">
                <input id="email" type="email" class="w-full border border-slate-300 p-3 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Email Admin" required>
                <input type="password" id="password" class="w-full border border-slate-300 p-3 rounded-lg mb-6 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Password" required>
                <button class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg font-bold shadow-lg transition transform hover:scale-[1.02]">MASUK SISTEM</button>
            </form>
        </div>
    </div>

    <div id="app-section" class="hidden min-h-screen flex flex-col pb-20">
        <nav class="bg-white border-b border-slate-200 h-16 px-4 md:px-6 flex justify-between items-center shadow-sm sticky top-0 z-40">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 text-white w-8 h-8 rounded flex items-center justify-center font-bold">V8</div>
                <div class="flex flex-col">
                    <span class="font-bold text-slate-800 leading-tight">Naruna Payroll</span>
                    <span class="text-[10px] text-slate-400 font-mono">STABLE</span>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleConsole()" class="text-slate-500 hover:text-blue-600 p-2" title="Debug Log"><i class="fas fa-bug"></i></button>
                <button onclick="auth.signOut()" class="bg-red-50 text-red-600 px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-red-100 transition"><i class="fas fa-power-off mr-1"></i> Keluar</button>
            </div>
        </nav>

        <main class="flex-1 p-4 md:p-6 max-w-6xl mx-auto w-full space-y-6">

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center cursor-pointer hover:bg-slate-100 transition" onclick="toggleSection('header-content')">
                    <h2 class="font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-image text-blue-500"></i> 1. Pengaturan Kop Surat</h2>
                    <i class="fas fa-chevron-down text-slate-400 transition-transform duration-300" id="icon-header-content"></i>
                </div>
                <div id="header-content" class="p-4 hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <label class="cursor-pointer group h-32">
                            <div class="border-2 border-dashed border-slate-300 rounded-lg h-full flex flex-col justify-center items-center text-center group-hover:border-blue-500 transition bg-slate-50 hover:bg-blue-50">
                                <i class="fas fa-cloud-upload-alt text-slate-400 mb-2 text-xl group-hover:text-blue-500"></i>
                                <span class="text-sm font-medium text-slate-600">Upload Kop Baru</span>
                                <input type="file" id="header-upload" accept="image/*" class="hidden" onchange="handleHeaderUpload(this)"/>
                            </div>
                        </label>
                        <div class="border border-slate-200 rounded-lg p-2 bg-slate-50 flex flex-col">
                            <div id="active-header-preview" class="flex-1 bg-white border border-slate-300 rounded flex items-center justify-center overflow-hidden relative">
                                <span class="text-xs text-slate-400 absolute">Preview Kop Aktif</span>
                            </div>
                        </div>
                    </div>
                    <div id="header-gallery" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center cursor-pointer hover:bg-slate-100 transition" onclick="toggleSection('master-content')">
                    <h2 class="font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-users text-blue-500"></i> 2. Master Data Karyawan</h2>
                    <i class="fas fa-chevron-down text-slate-400 transition-transform duration-300" id="icon-master-content"></i>
                </div>
                <div id="master-content" class="p-4 hidden">
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <label class="flex-1 cursor-pointer group">
                            <span class="block text-sm font-medium text-slate-700 mb-1">Update Master (Via Excel)</span>
                            <div class="border-2 border-dashed border-slate-300 rounded-lg p-4 text-center group-hover:border-green-500 transition bg-slate-50">
                                <i class="fas fa-file-excel text-green-600 mb-2 text-xl"></i>
                                <span class="block text-xs text-slate-500">Klik untuk upload data kontak baru</span>
                                <span class="block text-[10px] text-slate-400 mt-1">Wajib ada kolom: NAMA, NO HP</span>
                                <input type="file" id="master-excel-upload" accept=".xlsx,.xls" class="hidden"/> 
                            </div>
                        </label>
                        <div class="flex-1 bg-blue-50 rounded-lg p-4 flex flex-col justify-center items-center text-center border border-blue-100">
                            <span class="text-xs text-blue-600 uppercase font-bold tracking-wider mb-1">Total Kontak Tersimpan</span>
                            <span id="master-count" class="text-3xl font-bold text-blue-900">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg border border-blue-100 overflow-hidden relative">
                <div class="absolute top-0 left-0 w-1 h-full bg-green-500"></div> 
                <div class="bg-white p-4 border-b border-slate-100">
                    <div class="flex items-center gap-3">
                        <div class="bg-green-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm shadow-md shadow-green-200">3</div>
                        <div>
                            <h2 class="font-bold text-slate-800 text-lg">Upload Gaji (SSOT)</h2>
                            <p class="text-xs text-slate-500">Auto-Archive Original File & Smart Parsing</p>
                        </div>
                    </div>
                </div>

                <div class="p-5">
                    <label class="block mb-4 cursor-pointer group">
                        <div class="bg-green-50 hover:bg-green-100 border-2 border-green-200 border-dashed rounded-xl p-8 text-center transition">
                            <i class="fas fa-file-invoice-dollar text-4xl text-green-600 mb-3 group-hover:scale-110 transition-transform"></i>
                            <h3 class="font-bold text-green-900 text-lg">Pilih File Excel Gaji</h3>
                            <p class="text-sm text-green-700 mt-1">Support Format Indonesia (1.500.000) & US (1,500.000)</p>
                            <input type="file" id="payroll-file" accept=".xlsx,.xls,.csv" class="hidden"/>
                        </div>
                    </label>

                    <div id="payroll-result" class="hidden mt-8">
                        <div class="flex justify-between items-end mb-3 px-1">
                            <div>
                                <h3 class="font-bold text-slate-700 text-lg">Hasil Analisa</h3>
                                <p class="text-xs text-slate-500">Pastikan badge 'OK' sebelum kirim.</p>
                            </div>
                            <span class="text-xs bg-slate-800 text-white px-3 py-1.5 rounded-full font-bold shadow-sm" id="process-count-badge">0 Data</span>
                        </div>
                        <div class="overflow-x-auto custom-scroll border rounded-lg shadow-sm max-h-[500px]">
                            <table class="w-full text-sm text-left whitespace-nowrap relative">
                                <thead class="bg-slate-800 text-slate-200 uppercase text-xs sticky top-0 z-20">
                                    <tr>
                                        <th class="p-3 w-10">Status</th>
                                        <th class="p-3">Karyawan</th>
                                        <th class="p-3 text-right">Excel THP (Final)</th>
                                        <th class="p-3 text-right border-l border-slate-600">Audit System</th>
                                        <th class="p-3 text-center sticky right-0 bg-slate-800 z-30 w-24">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="payroll-table-body" class="divide-y divide-slate-100 bg-white">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="debug-console"><div id="console-body" class="overflow-y-auto p-2 h-48 custom-scroll"></div></div>
    <div id="render-area"></div>

    <script>
        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = { apiKey: "AIzaSyAecwXgmT8rMGw1LpXKTS3xX-2YPcDlZZw", authDomain: "naruna-payroll.firebaseapp.com", projectId: "naruna-payroll", storageBucket: "naruna-payroll.firebasestorage.app", messagingSenderId: "209087490496", appId: "1:209087490496:web:f632b7a1cc3fa9166f4025" };
        
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const auth = firebase.auth(); 
        const db = firebase.firestore(); 
        const storage = firebase.storage();
        
        // --- STATE MANAGEMENT ---
        let masterKaryawanList = [];
        let selectedHeaderImg = null; 
        let unsubscribeKaryawan = null; 

        // --- UTILITIES & FORMATTERS ---
        
        function toggleSection(id) {
            const el = document.getElementById(id); 
            const icon = document.getElementById('icon-'+id);
            if(!el) return;
            el.classList.toggle('hidden');
            if (icon) {
                icon.style.transform = el.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
            }
        }

        function toggleConsole() { 
            const con = document.getElementById('debug-console');
            if(con) con.classList.toggle('open'); 
        }

        function showLoading(show, text="Processing...") { 
            const overlay = document.getElementById('loading-overlay');
            const txt = document.getElementById('loading-text');
            if(overlay) overlay.style.display = show ? 'flex' : 'none'; 
            if(txt) txt.innerText = text; 
        }
        
        // --- [CRITICAL FIX] INTELLIGENT NUMBER PARSER ---
        function cleanNum(raw) { 
            if (raw === null || raw === undefined || raw === '') return 0;
            if (typeof raw === 'number') return raw;
            
            let s = String(raw).trim();
            if (!s) return 0;

            // Bersihkan currency symbol & whitespace
            s = s.replace(/[^0-9.,-]/g, ''); 

            // Deteksi Format:
            // Kasus 1: Mengandung koma DAN titik (Format Campuran)
            // ex: 1.500.000,00 (Indo) atau 1,500,000.00 (US)
            if (s.indexOf('.') !== -1 && s.indexOf(',') !== -1) {
                const lastDot = s.lastIndexOf('.');
                const lastComma = s.lastIndexOf(',');
                
                if (lastDot > lastComma) {
                    // Titik di akhir -> US Format (Hapus koma, biarkan titik desimal)
                    s = s.replace(/,/g, ''); 
                } else {
                    // Koma di akhir -> Indo Format (Hapus titik, ganti koma jadi titik)
                    s = s.replace(/\./g, '').replace(',', '.');
                }
            } 
            // Kasus 2: Hanya Koma
            else if (s.indexOf(',') !== -1) {
                 // Cek posisi koma. Jika 3 digit terakhir (xxx,xxx) -> Ribuan. Jika 2 (xxx,xx) -> Desimal
                 // Asumsi aman payroll: Jika format '1,234' biasanya ribuan.
                 // Tapi '1,5' biasanya desimal.
                 // Kita gunakan pendekatan moderat: 
                 // Replace koma jadi titik untuk parsing standard JS
                 
                 // Namun, untuk Excel Indo seringkali 1,500,000 adalah 1.5 Juta (koma = desimal) SALAH
                 // Excel Indo: 1500000. Excel US: 1,500,000
                 
                 // SAFE FALLBACK: Hapus koma dianggap ribuan dulu jika > 3 digit
                 // Ini sulit tanpa locale, tapi kita prioritaskan Indo format standard (Tanpa koma ribuan)
                 
                 // Jika format 1,234.56 sudah terhandle di atas.
                 // Jika format 1234,56 (Indo desimal)
                 s = s.replace(',', '.');
            }
            // Kasus 3: Hanya Titik (1.500.000 atau 1.5)
            else if (s.indexOf('.') !== -1) {
                // Jika titik muncul lebih dari sekali (1.000.000) -> Ribuan -> Hapus
                if ((s.match(/\./g) || []).length > 1) {
                    s = s.replace(/\./g, '');
                } else {
                    // Muncul sekali. 1.500 (bisa 1500 atau 1 koma 5)
                    // Di payroll gaji, jarang ada 1.5 rupiah. Asumsi Ribuan.
                    // Kecuali angka kecil (< 100).
                    const parts = s.split('.');
                    if (parts[1].length === 3) {
                         s = s.replace(/\./g, ''); // 1.500 -> 1500
                    }
                    // else biarkan float
                }
            }

            let val = parseFloat(s);
            return isNaN(val) ? 0 : val;
        }

        const fmtMoney = (n) => {
            if (n === null || n === undefined || n === '') return '0';
            return Number(n).toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        };

        // --- AUTH & DATA LOGIC ---
        auth.onAuthStateChanged(u => {
            const loginSec = document.getElementById('login-section');
            const appSec = document.getElementById('app-section');
            
            if(u) {
                if(loginSec) loginSec.classList.add('hidden');
                if(appSec) appSec.classList.remove('hidden');
                loadData();
                initHeaderSystem();
                toggleSection('header-content'); 
            } else {
                if(loginSec) loginSec.classList.remove('hidden');
                if(appSec) appSec.classList.add('hidden');
                if(unsubscribeKaryawan) unsubscribeKaryawan();
            }
        });

        function handleLogin(e){ 
            e.preventDefault(); 
            showLoading(true, "Authenticating..."); 
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            
            auth.signInWithEmailAndPassword(email, pass)
                .catch(err => { alert("Login Gagal: " + err.message); }) 
                .finally(() => showLoading(false)); 
        }

        function loadData() {
            if(unsubscribeKaryawan) unsubscribeKaryawan();
            
            unsubscribeKaryawan = db.collection('karyawan').onSnapshot(s => {
                masterKaryawanList = [];
                s.forEach(d => { masterKaryawanList.push(d.data()); });
                const countEl = document.getElementById('master-count');
                if(countEl) countEl.innerText = masterKaryawanList.length;
            }, err => {
                console.error("Gagal load master:", err);
            });
        }

        // --- MASTER DATA UPLOAD (SAFE BATCH) ---
        document.getElementById('master-excel-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if(!file) return;
            
            if(!confirm("Anda akan mengupdate data master kontak karyawan. Lanjutkan?")) {
                e.target.value = ''; return;
            }

            showLoading(true, "Update Database Kontak...");
            
            const reader = new FileReader();
            reader.onload = async (evt) => {
                try {
                    const wb = XLSX.read(evt.target.result, {type:'binary'});
                    const sheet = wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet, {defval:''});

                    const batchLimit = 400; 
                    let batch = db.batch();
                    let operationCount = 0;
                    let successCount = 0;

                    for (let i = 0; i < json.length; i++) {
                        const row = json[i];
                        const keys = Object.keys(row);
                        const keyNama = keys.find(k => k.toUpperCase().includes("NAMA"));
                        const keyHP = keys.find(k => /HP|WA|TELP|PHONE|CONTACT/.test(k.toUpperCase()));

                        if (keyNama && keyHP && row[keyNama]) {
                            const rawNama = String(row[keyNama]).trim();
                            let rawHP = String(row[keyHP]).replace(/[^0-9]/g, '');
                            
                            if (rawHP.startsWith('0')) rawHP = '62' + rawHP.slice(1);
                            if (rawHP.startsWith('62')) {
                                // [CRITICAL FIX] Use WA as Doc ID to prevent Name Collision
                                const docId = rawHP; // Primary Key is now WA Number
                                const ref = db.collection('karyawan').doc(docId);
                                
                                batch.set(ref, {
                                    nama: rawNama,
                                    wa: rawHP,
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                }); // Use set (overwrite) or update based on preference. Set is safer for sync.
                                
                                operationCount++;
                                successCount++;

                                if (operationCount >= batchLimit) {
                                    await batch.commit();
                                    batch = db.batch(); 
                                    operationCount = 0;
                                }
                            }
                        }
                    }

                    if (operationCount > 0) {
                        await batch.commit();
                    }

                    alert(`Sukses! ${successCount} data kontak diperbarui.`);
                    e.target.value = ''; 

                } catch (err) {
                    alert("Gagal update master: " + err.message);
                } finally {
                    showLoading(false);
                }
            };
            reader.readAsBinaryString(file);
        });

        // --- HEADER SYSTEM ---
        function initHeaderSystem() {
            try {
                const savedHeaders = JSON.parse(localStorage.getItem('savedHeaders')) || [];
                const activeIndex = localStorage.getItem('activeHeaderIndex');
                renderHeaderGallery(savedHeaders, activeIndex);
                if (activeIndex !== null && savedHeaders[activeIndex]) { 
                    selectedHeaderImg = savedHeaders[activeIndex]; 
                    updateActivePreview(selectedHeaderImg); 
                }
            } catch(e) { console.error("Header storage corrupt", e); }
        }

        function handleHeaderUpload(input) {
            const file = input.files[0]; if (!file) return;
            if(file.size > 2 * 1024 * 1024) { alert("File kop terlalu besar (Max 2MB)"); return; }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                const savedHeaders = JSON.parse(localStorage.getItem('savedHeaders')) || [];
                savedHeaders.push(base64);
                localStorage.setItem('savedHeaders', JSON.stringify(savedHeaders));
                
                const newIndex = savedHeaders.length - 1;
                localStorage.setItem('activeHeaderIndex', newIndex);
                selectedHeaderImg = base64;
                renderHeaderGallery(savedHeaders, newIndex);
                updateActivePreview(base64);
            };
            reader.readAsDataURL(file);
        }

        function renderHeaderGallery(headers, activeIndex) {
            const gallery = document.getElementById('header-gallery');
            if(!gallery) return;
            
            const html = headers.map((imgSrc, idx) => {
                const isActive = idx == activeIndex;
                return `
                <div class="kop-item relative h-20 bg-slate-100 rounded cursor-pointer overflow-hidden ${isActive ? 'active' : ''}" 
                     onclick="selectHeader(${idx})">
                    <img src="${imgSrc}" class="w-full h-full object-cover" />
                    ${isActive ? '<div class="absolute bottom-0 right-0 bg-blue-600 text-white text-[10px] px-1 font-bold">AKTIF</div>' : ''}
                </div>`;
            }).join('');
            gallery.innerHTML = html;
        }
        
        window.selectHeader = (idx) => {
            const savedHeaders = JSON.parse(localStorage.getItem('savedHeaders')) || [];
            if(savedHeaders[idx]) {
                localStorage.setItem('activeHeaderIndex', idx);
                selectedHeaderImg = savedHeaders[idx];
                renderHeaderGallery(savedHeaders, idx);
                updateActivePreview(selectedHeaderImg);
            }
        };

        function updateActivePreview(src) { 
            const el = document.getElementById('active-header-preview');
            if(el) el.innerHTML = `<img src="${src}" class="w-full h-auto" />`; 
        }

        // --- CORE EXCEL PARSER ---
        document.getElementById('payroll-file').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if(!file) return;

            // [SECURITY FIX] Archive Upload Validation
            if (auth.currentUser) {
                const validTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-excel', 'text/csv'];
                if(validTypes.includes(file.type) || file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                     const uniqueName = Date.now() + '_' + file.name;
                     storage.ref().child('excel_archives/' + uniqueName).put(file)
                        .then(() => console.log("[Archive] Success"))
                        .catch(err => console.error("[Archive] Failed", err));
                } else {
                    console.warn("[Archive] Invalid file type skipped");
                }
            }

            showLoading(true, "Menganalisa Struktur Excel...");
            
            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    const wb = XLSX.read(evt.target.result, {type:'binary'});
                    const rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1, defval: ''});
                    
                    let hIdx = -1;
                    for(let i=0; i<30; i++) { 
                        const rowStr = JSON.stringify(rawData[i]||[]).toUpperCase();
                        if(rowStr.includes("NAMA")) { hIdx = i; break; } 
                    }
                    if(hIdx === -1) throw new Error("Header tidak ditemukan (Kolom NAMA wajib ada).");

                    const header = rawData[hIdx].map(x => String(x).toUpperCase().trim());
                    const getCol = (names) => header.findIndex(h => names.some(n => h === n || h.includes(n)));

                    const col = {
                        nama: getCol(["NAMA", "NAMA KARYAWAN"]), 
                        nik: getCol(["NIK", "NO INDUK"]), 
                        outlet: getCol(["DIVISI", "BAGIAN", "OUTLET"]),
                        
                        thp_excel: getCol(["THP", "TAKE HOME PAY", "TOTAL DITERIMA", "TOTAL GAJI DITERIMA"]),
                        hk_excel: getCol(["HARI KERJA", "HK", "TOTAL MASUK"]),

                        // Income
                        gp: getCol(["GAJI POKOK", "GAPOK"]), 
                        tunj: getCol(["TUNJANGAN JABATAN"]), 
                        omset: getCol(["BONUS OMSET", "OMSET"]), 
                        kinerja: getCol(["BONUS KINERJA", "KINERJA"]), 
                        like: getCol(["LIKE KOMEN", "BONUS LIKE"]), 
                        kebijakan: getCol(["KEBIJAKAN"]), 

                        // Deduct
                        bpjs_kes: getCol(["BPJS KESEHATAN", "BPJS KES"]), 
                        bpjs_tk: getCol(["BPJS KETENAGAKERJAAN", "BPJS TK"]), 
                        weekend_rp: getCol(["WEEKEND", "HARI BESAR"]),
                        
                        // Counter
                        lembur_cnt: getCol(["JML LEMBUR", "LEMBUR HARIAN"]),
                        ot_cnt: getCol(["JML OT", "JAM OT", "OVERTIME ( 5000/ JAM )"]),
                        absen_cnt: getCol(["JML ABSEN", "HARI ABSEN"]),
                        pot_jam_cnt: getCol(["JML POT JAM", "JAM TERLAMBAT"])
                    };

                    const findNominal = (keywords, counterIdx) => {
                        const explicitIdx = getCol(keywords);
                        if(explicitIdx !== -1) return explicitIdx;
                        
                        if(counterIdx !== -1) {
                            const candidateIdx = counterIdx + 1;
                            // [FIX] Cek isi row nanti, sekarang cek header dulu agar tidak out of bound
                            if(header[candidateIdx]) return candidateIdx;
                        }
                        return -1;
                    };

                    col.lembur_rp = findNominal(["LEMBUR (RP)", "NOMINAL LEMBUR"], col.lembur_cnt);
                    col.ot_rp = findNominal(["OVERTIME (RP)", "NOMINAL OT"], col.ot_cnt);
                    col.absen_rp = findNominal(["POTONGAN ABSEN", "NOMINAL ABSEN"], col.absen_cnt);
                    col.pot_jam_rp = findNominal(["POTONGAN JAM (RP)", "NOMINAL POT JAM"], col.pot_jam_cnt);

                    const dataRows = rawData.slice(hIdx+1);
                    
                    const processedData = dataRows.map((row, idx) => {
                        if(!row[col.nama]) return null;
                        const rawNama = String(row[col.nama]).trim();
                        if(rawNama.length < 2 || /TOTAL|SUBTOTAL/i.test(rawNama)) return null;

                        const v = (idx) => (idx > -1) ? cleanNum(row[idx]) : 0;
                        const c = (idx) => (idx > -1) ? row[idx] : 0;

                        const inc = { 
                            gp: v(col.gp), tunj: v(col.tunj), omset: v(col.omset), kinerja: v(col.kinerja), 
                            like: v(col.like), lembur: v(col.lembur_rp), ot: v(col.ot_rp), kebijakan: v(col.kebijakan) 
                        };
                        const ded = { 
                            absen: v(col.absen_rp), bpjs_kes: v(col.bpjs_kes), bpjs_tk: v(col.bpjs_tk), 
                            weekend: v(col.weekend_rp), pot_jam: v(col.pot_jam_rp) 
                        };

                        const sum_in = Object.values(inc).reduce((a,b)=>a+b, 0);
                        const sum_out = Object.values(ded).reduce((a,b)=>a+b, 0);
                        
                        const thp_system = sum_in - sum_out;
                        const thp_excel = v(col.thp_excel);
                        const diff = Math.abs(thp_system - thp_excel);

                        // [CRITICAL FIX] STRICT NAME MATCHING
                        const normalize = (str) => str.toLowerCase().replace(/[^a-z0-9 ]/g, '').split(' ').filter(x => x.length > 0);
                        const tokens1 = normalize(rawNama);
                        
                        const matched = masterKaryawanList.find(m => {
                            const tokens2 = normalize(m.nama);
                            const short = tokens1.length < tokens2.length ? tokens1 : tokens2;
                            const long = tokens1.length < tokens2.length ? tokens2 : tokens1;
                            
                            // [FIX] 1 Word must be EXACT MATCH (Adi != Aditya)
                            if (short.length === 1) return short[0] === long[0];
                            
                            // Multi word: all tokens must exist
                            return short.every(t => long.includes(t));
                        });

                        return {
                            NIK: row[col.nik] || '-',
                            NAMA: rawNama,
                            DIVISI: row[col.outlet] || 'STAFF',
                            HK: (col.hk_excel > -1) ? c(col.hk_excel) : "-",
                            COUNTS: { lembur: c(col.lembur_cnt), ot: c(col.ot_cnt), absen: c(col.absen_cnt), pot_jam: c(col.pot_jam_cnt) },
                            INCOME: inc,
                            DEDUCT: ded,
                            SUM_IN: sum_in,   // [FIX] Data Loss Fixed
                            SUM_OUT: sum_out, // [FIX] Data Loss Fixed
                            THP_EXCEL: thp_excel,
                            THP_SYSTEM: thp_system,
                            DIFF: diff,
                            WA: matched ? matched.wa : null
                        };
                    }).filter(item => item !== null);

                    renderPayrollTable(processedData);
                    document.getElementById('process-count-badge').innerText = processedData.length + " Karyawan";
                    document.getElementById('payroll-result').classList.remove('hidden');

                } catch(err) { alert("Error Parsing: " + err.message); }
                showLoading(false);
            };
            reader.readAsBinaryString(file);
        });

        function renderPayrollTable(dataList) {
            const tbody = document.getElementById('payroll-table-body');
            if(!tbody) return;

            const htmlRows = dataList.map(d => {
                const hasWa = !!d.WA;
                const isDiff = d.DIFF > 1; 
                const dataStr = encodeURIComponent(JSON.stringify(d));
                
                return `
                <tr class="border-b hover:bg-slate-50 transition-colors">
                    <td class="p-3">${hasWa ? '<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold shadow-sm">MATCH</span>' : '<span class="bg-red-100 text-red-600 px-2 py-1 rounded text-xs font-bold shadow-sm">NO HP</span>'}</td>
                    <td class="p-3">
                        <div class="font-bold text-slate-700 text-sm">${d.NAMA}</div>
                        <div class="text-[10px] text-slate-400 font-mono">${d.NIK}</div>
                    </td>
                    <td class="p-3 text-right">
                        <div class="font-bold text-green-800 text-sm">${fmtMoney(d.THP_EXCEL)}</div>
                        ${isDiff ? `<div class="text-[10px] text-red-500 font-mono font-bold bg-red-50 p-1 rounded mt-1">⚠️ Sys: ${fmtMoney(d.THP_SYSTEM)}</div>` : ''}
                    </td>
                    <td class="p-3 text-right border-l border-slate-200">
                        ${isDiff ? `<div class="badge-diff text-center cursor-help" title="Selisih ${fmtMoney(d.DIFF)}">Diff: ${fmtMoney(d.DIFF)}</div>` : '<div class="badge-ssot text-center">OK</div>'}
                    </td>
                    <td class="p-3 text-center sticky right-0 bg-white z-10">
                        ${hasWa ? `<button onclick="initSend(this, '${dataStr}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg shadow-md text-xs font-bold transition transform hover:scale-105 active:scale-95 flex items-center justify-center gap-1 mx-auto w-full"><i class="fab fa-whatsapp"></i> KIRIM</button>` : '<span class="text-slate-300">-</span>'}
                    </td>
                </tr>`;
            }).join('');

            tbody.innerHTML = htmlRows;
        }

        window.initSend = (btn, dataEncoded) => {
            const data = JSON.parse(decodeURIComponent(dataEncoded));
            
            // [FIX] Warning if Diff exists
            if(data.DIFF > 100) {
                if(!confirm(`⚠️ PERHATIAN!\n\nAda selisih Rp ${fmtMoney(data.DIFF)} antara Excel vs Perhitungan Sistem.\n\nExcel: ${fmtMoney(data.THP_EXCEL)}\nSistem: ${fmtMoney(data.THP_SYSTEM)}\n\nTetap kirim sesuai angka EXCEL?`)) {
                    return;
                }
            }
            uploadAndSend(btn, data, data.WA);
        };

        // --- GENERATE & SEND ---
        async function uploadAndSend(btn, data, waNumber) {
            if(!selectedHeaderImg) { alert("Mohon pilih Kop Surat terlebih dahulu!"); return; }
            
            if(btn.disabled) return;
            const originalText = btn.innerHTML;
            const originalClass = btn.className;
            
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Wait`; 
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            
            let formattedWa = String(waNumber).replace(/[^0-9]/g, '');
            if (formattedWa.startsWith('0')) formattedWa = '62' + formattedWa.slice(1);
            if (formattedWa.length < 10) {
                alert("Nomor WA tidak valid");
                resetBtn();
                return;
            }

            try {
                const area = document.getElementById('render-area');
                const tgl = new Date().toLocaleDateString('id-ID', {day: '2-digit', month: 'long', year: 'numeric'});
                const bln = new Date().toLocaleDateString('id-ID', {month: 'long'}).toUpperCase();
                
                // [FIX] Consistent Table Column Count (5 Cols)
                const rowVal = (label, val) => `<tr><td style="width:45%; padding:3px 0;">${label}</td><td style="width:15%;"></td><td style="width:2%;">:</td><td style="width:5%;">Rp</td><td style="width:33%; text-align:right;">${fmtMoney(val)}</td></tr>`;
                const rowCnt = (label, cnt, unit, val) => `<tr><td style="width:45%; padding:3px 0;">${label}</td><td style="width:15%; text-align:center; font-size:11px;">${cnt && cnt!=0 ? cnt+' '+unit : ''}</td><td style="width:2%;">:</td><td style="width:5%;">Rp</td><td style="width:33%; text-align:right;">${fmtMoney(val)}</td></tr>`;

                area.innerHTML = `
                <div class="payslip-container" style="background:white; padding-bottom: 20px; font-family: sans-serif;">
                    <img src="${selectedHeaderImg}" style="width:100%; height:auto;">
                    <div style="text-align:center; margin-top:10px;"><h2 style="font-weight:bold; font-size:16px; margin:0;">SLIP GAJI</h2></div>
                    
                    <div style="padding:0 30px; margin-top:15px; margin-bottom:10px;">
                        <table style="width:100%; font-size:14px; font-weight:bold;">
                            <tr><td style="width:100px;">NAMA</td><td>:</td><td style="text-transform:uppercase;">${data.NAMA}</td></tr>
                            <tr><td>DIVISI</td><td>:</td><td style="text-transform:uppercase;">${data.DIVISI}</td></tr>
                            <tr><td>PERIODE</td><td>:</td><td>${bln}</td></tr>
                            <tr><td>HARI KERJA</td><td>:</td><td>${data.HK}</td></tr>
                        </table>
                    </div>

                    <div style="padding:0 30px;">
                        <table style="width:100%; font-size:14px; border-collapse:collapse;">
                            <tr><td style="width:45%;"></td><td style="width:15%;"></td><td style="width:2%;"></td><td style="width:5%;"></td><td style="width:33%;"></td></tr>
                            
                            ${rowVal('GAJI POKOK', data.INCOME.gp)}
                            ${rowVal('TUNJANGAN JABATAN', data.INCOME.tunj)}
                            ${rowVal('BONUS OMSET', data.INCOME.omset)}
                            ${rowVal('BONUS KINERJA', data.INCOME.kinerja)}
                            ${rowVal('BONUS LIKE KOMEN', data.INCOME.like)}
                            ${rowCnt('LEMBUR HARIAN', data.COUNTS.lembur, 'HR', data.INCOME.lembur)}
                            ${rowCnt('OVERTIME', data.COUNTS.ot, 'JAM', data.INCOME.ot)}
                            ${rowVal('KEBIJAKAN', data.INCOME.kebijakan)}
                            
                            <tr><td colspan="5" style="border-bottom:1px solid #ccc; padding:5px 0;"></td></tr>
                            <tr style="font-weight:bold;"><td style="padding-top:5px;">TOTAL INCOME</td><td></td><td style="padding-top:5px;">:</td><td style="padding-top:5px;">Rp</td><td style="text-align:right; padding-top:5px;">${fmtMoney(data.SUM_IN)}</td></tr>
                            
                            <tr><td colspan="5" style="height:15px;"></td></tr>

                            ${rowCnt('POTONGAN ABSEN', data.COUNTS.absen, 'HR', data.DEDUCT.absen)}
                            ${rowVal('BPJS KESEHATAN', data.DEDUCT.bpjs_kes)}
                            ${rowVal('BPJS KETENAGAKERJAAN', data.DEDUCT.bpjs_tk)}
                            ${rowCnt('POTONGAN JAM', data.COUNTS.pot_jam, 'JAM', data.DEDUCT.pot_jam)}
                            ${rowVal('WEEKEND / HARI BESAR', data.DEDUCT.weekend)}

                            <tr><td colspan="5" style="border-bottom:2px solid #000; padding:10px 0;"></td></tr>
                            <tr style="font-weight:bold; background-color:#ffff00; font-size:16px;">
                                <td style="padding:10px 0 10px 5px;">TOTAL DITERIMA</td><td></td><td>:</td><td>Rp</td><td style="text-align:right; padding-right:5px;">${fmtMoney(data.THP_EXCEL)}</td>
                            </tr>
                            <tr><td colspan="5" style="border-top:2px solid #000;"></td></tr>
                        </table>
                    </div>

                    <div style="margin-top:40px; padding-right:40px; text-align:right;">
                        <p>Salatiga, ${tgl}</p>
                        <br><br><br>
                        <p style="font-weight:bold; text-decoration:underline; text-transform:uppercase;">${data.NAMA}</p>
                    </div>
                </div>`;

                const canvas = await html2canvas(area.querySelector('.payslip-container'), {
                    scale: 1.5, 
                    useCORS: true,
                    logging: false 
                });
                
                canvas.toBlob(async (blob) => {
                    if(!blob) throw new Error("Gagal generate gambar");
                    const fname = `slip_${data.NAMA.replace(/\s/g,'_')}_${Date.now()}.jpg`;
                    
                    const ref = storage.ref().child('slips/'+fname);
                    const snap = await ref.put(blob, { customMetadata: { generatedBy: auth.currentUser.email } });
                    const url = await snap.ref.getDownloadURL();
                    
                    const msg = `Halo ${data.NAMA},\nBerikut Slip Gaji periode ${bln}.\n\n*Total Diterima: Rp ${fmtMoney(data.THP_EXCEL)}*\n\nSilakan unduh: ${url}\n\nTerima Kasih.`;
                    
                    window.open(`https://wa.me/${formattedWa}?text=${encodeURIComponent(msg)}`, '_blank');
                    
                    btn.innerHTML = `<i class="fas fa-check"></i> Terkirim`;
                    btn.className = "bg-green-600 text-white px-3 py-2 rounded-lg shadow-md text-xs font-bold flex items-center justify-center gap-1 mx-auto w-full cursor-default";
                    
                }, 'image/jpeg', 0.8);

            } catch(e) { 
                alert("Error: "+e.message); 
                resetBtn();
            }

            function resetBtn() {
                btn.innerHTML = originalText;
                btn.className = originalClass;
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
    </script>
</body>
</html>
