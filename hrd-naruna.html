<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dolan Payroll - V11 (Debug Console)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script>tailwind.config = { theme: { extend: { colors: { primary: '#1e3a8a' }, fontFamily: { sans: ['Inter'] } } } }</script>
    <style>
        body { background: #f1f5f9; font-family: 'Inter', sans-serif; padding-bottom: 200px; /* Space for console */ }
        .payslip-container { width: 800px; background: white; padding: 40px; border: 1px solid #cbd5e1; }
        .payslip-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .payslip-table td { padding: 4px 8px; vertical-align: top; }
        .val-col { text-align: right; font-weight: bold; }
        .total-row { background-color: #fef08a; font-weight: 800; border-top: 2px solid #000; }
        
        /* Floating Console Styles */
        #debug-console {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #0f172a; color: #38bdf8;
            font-family: 'Consolas', 'Monaco', monospace;
            border-top: 2px solid #334155;
            z-index: 9999;
            transition: height 0.3s ease;
            display: flex; flex-direction: column;
        }
        #console-header {
            padding: 8px 16px; background: #1e293b; border-bottom: 1px solid #334155;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer;
        }
        #console-body {
            height: 150px; overflow-y: auto; padding: 10px; font-size: 12px;
            background: #020617; color: #e2e8f0;
        }
        #console-body .log-entry { margin-bottom: 4px; border-bottom: 1px solid #1e293b; padding-bottom: 2px; }
        #console-body .log-time { color: #64748b; margin-right: 8px; }
        #console-body .log-err { color: #ef4444; font-weight: bold; }
        #console-body .log-success { color: #4ade80; }
        
        /* Loading Overlay */
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; justify-content: center; align-items: center; color: white; flex-direction: column; }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
        <h2 class="text-xl font-bold">Sedang memproses...</h2>
        <p id="loading-text" class="text-sm mt-2">Mengupload ke server...</p>
    </div>

    <div id="login-section" class="min-h-screen flex items-center justify-center bg-slate-800">
        <div class="bg-white p-8 rounded-xl w-96 shadow-2xl">
            <h2 class="text-2xl font-bold mb-6 text-center text-slate-700">Dolan Admin V11</h2>
            <form onsubmit="handleLogin(event)">
                <input id="email" class="w-full border p-3 rounded mb-3" placeholder="Email" required>
                <input type="password" id="password" class="w-full border p-3 rounded mb-6" placeholder="Password" required>
                <button class="w-full bg-blue-600 text-white p-3 rounded font-bold">LOGIN</button>
            </form>
        </div>
    </div>

    <div id="app-section" class="hidden min-h-screen flex flex-col">
        <nav class="bg-white border-b h-16 px-6 flex justify-between items-center shadow-sm sticky top-0 z-40">
            <div class="font-bold text-lg text-slate-700">Dolan<span class="text-blue-600">Payroll</span> System</div>
            <div class="flex gap-2 text-sm">
                <button onclick="switchTab('payroll')" class="px-3 py-2 bg-blue-600 text-white rounded shadow">Gaji</button>
                <button onclick="switchTab('karyawan')" class="px-3 py-2 bg-white border hover:bg-gray-50 rounded">Master Data</button>
                <button onclick="auth.signOut()" class="text-red-500 px-2"><i class="fas fa-power-off"></i></button>
            </div>
        </nav>

        <main class="p-6 max-w-6xl mx-auto w-full">
            <div id="tab-karyawan" class="tab-content hidden">
                <div class="bg-white p-6 rounded-lg shadow border mb-6">
                    <h2 class="font-bold text-lg mb-2">1. Upload Database HP</h2>
                    <p class="text-sm text-gray-500 mb-4">Upload <b>NAMA NOMOR TELEPON.xlsx</b></p>
                    <div class="mb-4">
                        <input type="file" id="master-excel-upload" accept=".xlsx,.xls" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    </div>
                    <div class="overflow-x-auto border rounded max-h-[400px]">
                        <table class="w-full text-sm text-left"><thead class="bg-gray-50 sticky top-0"><tr><th class="p-3">NIP</th><th class="p-3">Nama</th><th class="p-3">WhatsApp</th></tr></thead><tbody id="table-karyawan-body" class="divide-y"></tbody></table>
                    </div>
                </div>
            </div>

            <div id="tab-payroll" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow border mb-6">
                    <h2 class="font-bold text-lg mb-2">2. Upload Gaji (Auto Calc & Link)</h2>
                    <p class="text-sm text-gray-500 mb-4">Upload Excel Gaji. Sistem akan <b>menghitung ulang</b> Total dan membuat Link WA.</p>
                    <div class="mb-6">
                         <input type="file" id="payroll-file" accept=".xlsx,.xls" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"/>
                    </div>
                    <div id="payroll-result" class="hidden">
                        <h3 class="font-bold text-gray-700 mb-2 border-b pb-2">Preview Hasil Hitung</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-100">
                                    <tr><th class="p-2">Status</th><th class="p-2">NIK</th><th class="p-2">Nama</th><th class="p-2">Rincian (Juta)</th><th class="p-2 text-right">THP (Hitung)</th><th class="p-2">Aksi</th></tr>
                                </thead>
                                <tbody id="payroll-table-body" class="divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="debug-console">
        <div id="console-header" onclick="toggleConsoleHeight()">
            <div class="flex items-center gap-2">
                <i class="fas fa-terminal"></i> 
                <span class="font-bold">System Log</span>
                <span id="log-badge" class="bg-blue-600 text-white text-[10px] px-1 rounded hidden">New</span>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="copyLogToClipboard(event)" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded text-xs border border-slate-500">
                    <i class="fas fa-copy mr-1"></i> COPY LOG
                </button>
                <i class="fas fa-chevron-up transition-transform" id="console-icon"></i>
            </div>
        </div>
        <div id="console-body">
            <div class="log-entry">> System initialized. Waiting for user...</div>
        </div>
    </div>

    <div id="render-area" class="absolute left-[-9999px] top-0"></div>

    <script>
        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = { 
            apiKey: "AIzaSyAecwXgmT8rMGw1LpXKTS3xX-2YPcDlZZw", 
            authDomain: "naruna-payroll.firebaseapp.com", 
            projectId: "naruna-payroll", 
            storageBucket: "naruna-payroll.firebasestorage.app", 
            messagingSenderId: "209087490496", 
            appId: "1:209087490496:web:f632b7a1cc3fa9166f4025" 
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); 
        const db = firebase.firestore(); 
        const storage = firebase.storage();
        
        let masterKaryawanList = [];
        let masterOutlet = {};

        // --- NEW LOGGING SYSTEM ---
        let isConsoleExpanded = true;
        
        function log(msg, type='info') {
            const box = document.getElementById('console-body');
            const time = new Date().toLocaleTimeString('id-ID', {hour12:false});
            
            let colorClass = type === 'error' ? 'log-err' : (type === 'success' ? 'log-success' : '');
            
            // Format object jika msg adalah object error
            let textMsg = msg;
            if (typeof msg === 'object') {
                textMsg = JSON.stringify(msg, null, 2);
            }

            const entry = `<div class="log-entry ${colorClass}"><span class="log-time">[${time}]</span>${textMsg}</div>`;
            box.innerHTML += entry;
            box.scrollTop = box.scrollHeight;

            // Jika error, otomatis buka console agar terlihat
            if (type === 'error') {
                expandConsole();
                // Alert suara atau visual bisa ditambahkan disini
            }
        }

        function toggleConsoleHeight() {
            const consoleDiv = document.getElementById('debug-console');
            const bodyDiv = document.getElementById('console-body');
            const icon = document.getElementById('console-icon');
            
            if (isConsoleExpanded) {
                // Minimize
                bodyDiv.style.display = 'none';
                consoleDiv.style.height = 'auto';
                icon.style.transform = 'rotate(180deg)';
            } else {
                // Maximize
                bodyDiv.style.display = 'block';
                consoleDiv.style.height = 'auto';
                icon.style.transform = 'rotate(0deg)';
            }
            isConsoleExpanded = !isConsoleExpanded;
        }

        function expandConsole() {
            if (!isConsoleExpanded) toggleConsoleHeight();
        }

        function copyLogToClipboard(e) {
            e.stopPropagation(); // Mencegah toggle saat klik tombol copy
            const logText = document.getElementById('console-body').innerText;
            navigator.clipboard.writeText(logText).then(() => {
                const btn = e.target.closest('button');
                const oriText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> COPIED!';
                btn.classList.replace('bg-slate-700', 'bg-green-600');
                setTimeout(() => {
                    btn.innerHTML = oriText;
                    btn.classList.replace('bg-green-600', 'bg-slate-700');
                }, 2000);
            }).catch(err => {
                alert('Gagal copy: ' + err);
            });
        }

        // HELPERS
        function cleanStr(s) { return String(s||'').toLowerCase().replace(/[^a-z0-9]/g, ''); }
        function cleanPhone(p) { let s=String(p||'').replace(/[^0-9]/g,''); if(s.startsWith('08')) s='62'+s.slice(1); if(s.startsWith('8')) s='62'+s; return s; }
        function cleanNum(n) { 
            if(!n) return 0; 
            let s = String(n).replace(/Rp\.?/gi,'').replace(/\./g,'').replace(/,/g,'.').trim(); 
            s = s.replace(/[^0-9.-]/g, '');
            return parseFloat(s) || 0; 
        }

        // AUTH
        auth.onAuthStateChanged(u => {
            if(u) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('app-section').classList.remove('hidden');
                log(`User Logged In: ${u.email}`, 'success');
                loadData();
            } else {
                document.getElementById('login-section').classList.remove('hidden');
                document.getElementById('app-section').classList.add('hidden');
            }
        });
        function handleLogin(e){ 
            e.preventDefault(); 
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            log(`Attempting login for: ${email}...`);
            auth.signInWithEmailAndPassword(email, pass)
                .then(() => log("Login Success", "success"))
                .catch(e => {
                    alert(e.message);
                    log("Login Failed: " + e.message, "error");
                }); 
        }

        // LOAD DATA
        function loadData() {
            log("Connecting to Firestore...");
            db.collection('karyawan').onSnapshot(s => {
                const b = document.getElementById('table-karyawan-body'); b.innerHTML=''; masterKaryawanList = [];
                s.forEach(d => { 
                    const dt=d.data(); 
                    masterKaryawanList.push({ ...dt, id:d.id, cleanNama: cleanStr(dt.nama) });
                    b.innerHTML+=`<tr class="border-b"><td class="p-3 font-mono">${dt.nik}</td><td class="p-3 font-bold">${dt.nama}</td><td class="p-3 text-blue-500">${dt.wa||'-'}</td></tr>`; 
                });
                log(`Firestore Connected. Loaded ${masterKaryawanList.length} employees.`, "success");
            }, err => {
                log("Firestore Error (Karyawan): " + err.message, "error");
            });

            db.collection('outlets').onSnapshot(s => {
                masterOutlet={}; s.forEach(d => { const dt=d.data(); masterOutlet[dt.nama.toLowerCase()]={...dt}; });
                log("Outlet data loaded.", "success");
            }, err => {
                log("Firestore Error (Outlets): " + err.message, "error");
            });
        }

        // UPLOAD MASTER
        document.getElementById('master-excel-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if(!file) return;
            log(`Processing Master File: ${file.name}...`);
            const reader = new FileReader();
            reader.onload = async (evt) => {
                try {
                    const wb = XLSX.read(evt.target.result, {type:'binary'});
                    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    let batch = db.batch(); let count=0;
                    for(let row of rows) {
                        const k = Object.keys(row);
                        const nm = k.find(x=>x.toUpperCase().includes('NAMA'));
                        const hp = k.find(x=>x.toUpperCase().includes('PHONE')||x.toUpperCase().includes('HP'));
                        const nip = k.find(x=>x.toUpperCase().includes('NIP')||x.toUpperCase().includes('NIK'));
                        if(nm && hp) {
                            const rawName = String(row[nm]).trim();
                            const rawNip = nip ? String(row[nip]).trim() : `AUTO${Math.floor(Math.random()*99999)}`;
                            const ref = db.collection('karyawan').doc(cleanStr(rawNip));
                            batch.set(ref, { nik: rawNip, nama: rawName, wa: cleanPhone(row[hp]) }, {merge: true});
                            count++; if(count>=400){ await batch.commit(); batch=db.batch(); count=0;}
                        }
                    }
                    if(count>0) await batch.commit();
                    log(`Successfully updated ${rows.length} master records.`, "success");
                } catch(e) { log("Master Upload Error: " + e.message, "error"); }
            };
            reader.readAsBinaryString(file);
        });

        // PAYROLL LOGIC
        document.getElementById('payroll-file').addEventListener('change', (e) => {
            const file = e.target.files[0];
            log(`Processing Payroll File: ${file.name}...`);
            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    const wb = XLSX.read(evt.target.result, {type:'binary'});
                    const rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1});

                    let hIdx = -1;
                    for(let i=0; i<20; i++) { if(JSON.stringify(rawData[i]||[]).toUpperCase().includes("NAMA")) { hIdx = i; break; } }
                    if(hIdx === -1) throw new Error("Header 'NAMA' tidak ditemukan di 20 baris pertama.");

                    const tbody = document.getElementById('payroll-table-body');
                    tbody.innerHTML = '';
                    document.getElementById('payroll-result').classList.remove('hidden');

                    const dataRows = rawData.slice(hIdx+1);
                    let processedCount = 0;

                    dataRows.forEach((row) => {
                        const nik = row[0] ? String(row[0]) : '';
                        const nama = row[1];
                        if(!nik || !nama) return;

                        const matched = masterKaryawanList.find(m => m.cleanNama === cleanStr(nama) || m.cleanNama.includes(cleanStr(nama)));

                        const gp = cleanNum(row[4]);
                        const lembur = cleanNum(row[6]) + cleanNum(row[8]);
                        const bonus = cleanNum(row[10]) + cleanNum(row[11]);
                        const pot_absen = cleanNum(row[14]);
                        const bpjs = cleanNum(row[15]) + cleanNum(row[16]);
                        const casbon = cleanNum(row[17]);
                        const total_potongan = pot_absen + bpjs + casbon;
                        const total_diterima = (gp + lembur + bonus) - total_potongan;

                        const d = {
                            NIK: nik, NAMA: nama, OUTLET: row[2],
                            GP: gp, LEMBUR: lembur, BONUS: bonus,
                            POT_TOTAL: total_potongan, TOTAL: total_diterima
                        };

                        const wa = matched ? matched.wa : null;
                        const btn = wa ? `<button onclick='uploadAndSend(${JSON.stringify(d)},"${wa}")' class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs shadow"><i class="fab fa-whatsapp"></i> Kirim Link</button>` : '';

                        tbody.innerHTML += `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="p-2">${wa ? '<span class="text-green-600 font-bold text-xs">MATCH</span>' : '<span class="text-red-400 text-xs">No HP</span>'}</td>
                                <td class="p-2 text-xs font-mono">${d.NIK}</td>
                                <td class="p-2 font-bold">${d.NAMA}</td>
                                <td class="p-2 text-xs text-gray-500">GP: ${d.GP/1000}k | Lbr: ${d.LEMBUR/1000}k | Pot: ${d.POT_TOTAL/1000}k</td>
                                <td class="p-2 text-right font-bold text-blue-800">Rp ${d.TOTAL.toLocaleString('id-ID')}</td>
                                <td class="p-2 text-center">${btn}</td>
                            </tr>
                        `;
                        processedCount++;
                    });
                    log(`Calculated ${processedCount} payroll rows. Ready to send.`, "success");
                } catch(err) { log("Payroll Parse Error: "+err.message, "error"); }
            };
            reader.readAsBinaryString(file);
        });

        // UPLOAD AND SEND
        async function uploadAndSend(data, waNumber) {
            const loading = document.getElementById('loading-overlay');
            const loadText = document.getElementById('loading-text');
            loading.style.display = 'flex';
            loadText.innerText = `Generating Slip for ${data.NAMA}...`;
            log(`Starting upload process for ${data.NAMA}...`);

            try {
                const area = document.getElementById('render-area');
                const outletInfo = masterOutlet[(data.OUTLET||'').toLowerCase()] || {nama: data.OUTLET||'Outlet', logoUrl: ''};
                const fmt = n => 'Rp ' + Number(n).toLocaleString('id-ID');

                area.innerHTML = `
                <div class="payslip-container">
                    <div style="display:flex; align-items:center; border-bottom:3px solid #000; padding-bottom:20px; margin-bottom:20px">
                        ${outletInfo.logoUrl ? `<img src="${outletInfo.logoUrl}" style="width:100px; height:60px; object-fit:contain; margin-right:20px" crossorigin="anonymous">` : ''}
                        <div><h1 class="text-xl font-bold uppercase">${outletInfo.nama}</h1></div>
                    </div>
                    <h2 class="text-center font-bold text-lg border-b pb-2 mb-4">SLIP GAJI</h2>
                    <table class="payslip-table mb-4">
                        <tr><td width="150">NIK</td><td>: ${data.NIK}</td></tr>
                        <tr><td>NAMA</td><td>: ${data.NAMA}</td></tr>
                        <tr><td>PERIODE</td><td>: ${new Date().toLocaleDateString('id-ID', {month:'long', year:'numeric'})}</td></tr>
                    </table>
                    <table class="payslip-table">
                        <tr><td>GAJI POKOK</td><td>:</td><td class="val-col">${fmt(data.GP)}</td></tr>
                        <tr><td>LEMBUR</td><td>:</td><td class="val-col">${fmt(data.LEMBUR)}</td></tr>
                        <tr><td>BONUS</td><td>:</td><td class="val-col">${fmt(data.BONUS)}</td></tr>
                        <tr><td colspan="3" class="h-4"></td></tr>
                        <tr><td>POTONGAN</td><td>:</td><td class="val-col text-red-600">(${fmt(data.POT_TOTAL)})</td></tr>
                        <tr class="total-row"><td class="p-2">DITERIMA BERSIH</td><td class="p-2">:</td><td class="val-col p-2">${fmt(data.TOTAL)}</td></tr>
                    </table>
                    <div class="mt-12 text-right font-bold underline">${data.NAMA}</div>
                    <div class="mt-2 text-right text-xs text-gray-400">Generated by DolanSystem</div>
                </div>`;

                const img = area.querySelector('img');
                if(img && img.src) await new Promise(r => { if(img.complete)r(); else img.onload=r; setTimeout(r,1000); });

                const canvas = await html2canvas(area.querySelector('.payslip-container'), {scale: 2, useCORS: true});
                
                loadText.innerText = "Uploading to Cloud Storage...";
                
                canvas.toBlob(async (blob) => {
                    if (!blob) throw new Error("Canvas blob conversion failed");

                    const filename = `slip_${Date.now()}_${cleanStr(data.NAMA)}.jpg`;
                    const storageRef = storage.ref().child('slip_gaji/' + filename);
                    
                    log(`Uploading ${filename} to Firebase Storage...`);
                    const snapshot = await storageRef.put(blob);
                    log("Upload complete. Getting URL...");
                    const downloadURL = await snapshot.ref.getDownloadURL();

                    loading.style.display = 'none';
                    log(`Success! URL: ${downloadURL}`, "success");
                    
                    const message = `Halo ${data.NAMA},\n\nBerikut slip gaji bulan ini.\nTotal: ${fmt(data.TOTAL)}\n\nLink Slip: ${downloadURL}\n\nTerima kasih.`;
                    window.open(`https://wa.me/${waNumber}?text=${encodeURIComponent(message)}`, '_blank');

                }, 'image/jpeg', 0.85);

            } catch (err) {
                loading.style.display = 'none';
                alert("Gagal: " + err.message);
                log(err, "error"); // Log object error penuh untuk detail
            }
        }
        
        function switchTab(id) { document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); document.getElementById('tab-'+id).classList.remove('hidden'); }
    </script>
</body>
</html>
