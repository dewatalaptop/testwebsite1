<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dolan Payroll - V6 (Custom Header)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script>
        tailwind.config = { theme: { extend: { colors: { primary: '#0f172a', secondary: '#3b82f6' }, fontFamily: { sans: ['Inter'] } } } }
    </script>

    <style>
        body { background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .custom-scroll::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* Render Container diperbaiki agar sesuai ukuran kertas A4/Struk dan Font Arial */
        .payslip-container { 
            width: 800px; /* Resolusi tinggi untuk html2canvas */
            background: white; 
            padding: 0; /* Padding diatur di dalam elemen */
            font-family: Arial, Helvetica, sans-serif; /* Sesuai gambar referensi */
            color: #000;
        }
        
        #render-area {
            position: fixed;
            top: 0;
            left: 0;
            z-index: -50;
            opacity: 0;
            pointer-events: none;
        }

        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.9); z-index: 100; justify-content: center; align-items: center; color: white; flex-direction: column; backdrop-filter: blur(4px); }
        
        #debug-console { position: fixed; bottom: 0; left: 0; width: 100%; background: #1e293b; color: #cbd5e1; font-family: monospace; z-index: 50; transition: transform 0.3s ease; transform: translateY(100%); max-height: 40vh; display: flex; flex-direction: column; border-top-left-radius: 12px; border-top-right-radius: 12px; shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1); }
        #debug-console.open { transform: translateY(0); }
        .log-entry { padding: 4px 8px; border-bottom: 1px solid #334155; font-size: 11px; }
        .log-err { color: #f87171; background: rgba(254,226,226,0.1); }
        .log-success { color: #4ade80; }
        
        /* Style untuk pilihan Kop */
        .kop-item { border: 2px solid transparent; transition: all 0.2s; }
        .kop-item.active { border-color: #3b82f6; background-color: #eff6ff; }
    </style>
</head>
<body class="text-slate-800">

    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mb-4"></div>
        <h2 id="loading-text" class="text-lg font-semibold tracking-wide">Memproses...</h2>
    </div>

    <div id="login-section" class="min-h-screen flex items-center justify-center p-4 bg-slate-900">
        <div class="bg-white p-8 rounded-2xl w-full max-w-md shadow-2xl border-t-4 border-blue-600">
            <div class="text-center mb-8">
                <i class="fas fa-shield-alt text-4xl text-blue-600 mb-2"></i>
                <h2 class="text-2xl font-bold text-slate-800">Payroll V6</h2>
                <p class="text-slate-500 text-sm">Custom Header & Layout</p>
            </div>
            <form onsubmit="handleLogin(event)">
                <input id="email" type="email" class="w-full border border-slate-300 p-3 rounded-lg mb-4" placeholder="Email Admin" required>
                <input type="password" id="password" class="w-full border border-slate-300 p-3 rounded-lg mb-6" placeholder="Password" required>
                <button class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg font-bold shadow-lg">MASUK SISTEM</button>
            </form>
        </div>
    </div>

    <div id="app-section" class="hidden min-h-screen flex flex-col pb-20">
        <nav class="bg-white border-b border-slate-200 h-16 px-4 md:px-6 flex justify-between items-center shadow-sm sticky top-0 z-40">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 text-white w-8 h-8 rounded flex items-center justify-center font-bold">V6</div>
                <span class="font-bold text-slate-800 text-lg">Dolan Payroll</span>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleConsole()" class="text-slate-500 hover:text-blue-600 p-2"><i class="fas fa-bug"></i></button>
                <button onclick="auth.signOut()" class="bg-red-50 text-red-600 px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-red-100 transition"><i class="fas fa-power-off mr-1"></i> Keluar</button>
            </div>
        </nav>

        <main class="flex-1 p-4 md:p-6 max-w-5xl mx-auto w-full space-y-6">

            <div id="error-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-sm mb-4">
                <p class="font-bold">⚠️ Perhatian</p>
                <p id="error-text" class="text-sm"></p>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center cursor-pointer" onclick="toggleSection('header-content')">
                    <div class="flex items-center gap-3">
                        <div class="bg-purple-100 text-purple-700 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">1</div>
                        <div>
                            <h2 class="font-bold text-slate-700">Pengaturan Kop Surat</h2>
                            <p class="text-xs text-slate-500">Upload dan pilih kop yang akan digunakan</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-down text-slate-400 transition-transform" id="icon-header-content"></i>
                </div>
                
                <div id="header-content" class="p-4 hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <label class="cursor-pointer group h-32">
                            <div class="border-2 border-dashed border-slate-300 rounded-lg h-full flex flex-col justify-center items-center text-center group-hover:border-purple-500 transition bg-slate-50 hover:bg-purple-50">
                                <i class="fas fa-image text-slate-400 mb-2 text-xl group-hover:text-purple-500"></i>
                                <span class="text-sm font-medium text-slate-600">Tambah Gambar Kop Baru</span>
                                <input type="file" id="header-upload" accept="image/*" class="hidden" onchange="handleHeaderUpload(this)"/>
                            </div>
                        </label>
                        
                        <div class="border border-slate-200 rounded-lg p-2 bg-slate-50 flex flex-col">
                            <span class="text-xs font-bold text-slate-500 mb-2 uppercase">Kop Aktif Saat Ini:</span>
                            <div id="active-header-preview" class="flex-1 bg-white border border-slate-300 rounded flex items-center justify-center overflow-hidden relative">
                                <span class="text-xs text-slate-400 italic">Belum ada kop dipilih</span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h3 class="text-sm font-bold text-slate-700 mb-2">Galeri Kop Tersimpan</h3>
                        <div id="header-gallery" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            </div>
                        <button onclick="clearHeaderGallery()" class="mt-4 text-xs text-red-500 hover:text-red-700 underline">Hapus Semua Kop</button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center cursor-pointer" onclick="toggleSection('master-content')">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-100 text-blue-700 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">2</div>
                        <div>
                            <h2 class="font-bold text-slate-700">Master Data Karyawan</h2>
                        </div>
                    </div>
                    <i class="fas fa-chevron-down text-slate-400 transition-transform" id="icon-master-content"></i>
                </div>
                
                <div id="master-content" class="p-4 hidden">
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <label class="flex-1 cursor-pointer group">
                            <span class="block text-sm font-medium text-slate-700 mb-1">Update Master (.xlsx)</span>
                            <div class="border-2 border-dashed border-slate-300 rounded-lg p-4 text-center group-hover:border-blue-500 transition bg-slate-50">
                                <i class="fas fa-cloud-upload-alt text-slate-400 mb-2 text-xl"></i>
                                <input type="file" id="master-excel-upload" accept=".xlsx,.xls" class="hidden"/>
                            </div>
                        </label>
                        <div class="flex-1 bg-blue-50 rounded-lg p-4 flex flex-col justify-center items-center text-center">
                            <span class="text-xs text-blue-600 uppercase font-bold tracking-wider">Total Kontak</span>
                            <span id="master-count" class="text-2xl font-bold text-blue-900">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg border border-blue-100 overflow-hidden relative">
                <div class="absolute top-0 left-0 w-1 h-full bg-blue-600"></div>
                <div class="bg-white p-4 border-b border-slate-100">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm shadow-md shadow-blue-200">3</div>
                        <div>
                            <h2 class="font-bold text-slate-800 text-lg">Upload File Gaji</h2>
                        </div>
                    </div>
                </div>

                <div class="p-5">
                    <label class="block mb-4 cursor-pointer">
                        <div class="bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 border-dashed rounded-xl p-6 text-center transition">
                            <i class="fas fa-file-excel text-3xl text-green-600 mb-2"></i>
                            <h3 class="font-bold text-blue-900">Pilih File Excel Gaji</h3>
                            <input type="file" id="payroll-file" accept=".xlsx,.xls" class="hidden"/>
                        </div>
                    </label>

                    <div id="payroll-result" class="hidden mt-6">
                        <div class="flex justify-between items-end mb-3">
                            <h3 class="font-bold text-slate-700">Hasil Perhitungan</h3>
                            <span class="text-xs bg-slate-100 text-slate-700 px-2 py-1 rounded font-bold" id="process-count-badge">0 Data</span>
                        </div>
                        <div class="overflow-x-auto custom-scroll border rounded-lg shadow-sm">
                            <table class="w-full text-sm text-left whitespace-nowrap">
                                <thead class="bg-slate-800 text-slate-200 uppercase text-xs">
                                    <tr>
                                        <th class="p-3">Status</th>
                                        <th class="p-3">Karyawan</th>
                                        <th class="p-3 text-right">Income</th>
                                        <th class="p-3 text-right">Potongan</th>
                                        <th class="p-3 text-right font-bold bg-slate-700">THP (System)</th>
                                        <th class="p-3 text-center sticky right-0 bg-slate-800 z-10">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="payroll-table-body" class="divide-y divide-slate-100 bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="debug-console">
        <div class="bg-slate-800 p-2 flex justify-between items-center text-xs border-b border-slate-700 cursor-pointer" onclick="toggleConsole()">
            <span class="font-bold text-blue-400"><i class="fas fa-terminal mr-2"></i>System Logs</span>
            <i class="fas fa-chevron-down"></i>
        </div>
        <div id="console-body" class="overflow-y-auto p-2 h-48 custom-scroll"></div>
    </div>
    
    <div id="render-area"></div>

    <script>
        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = { apiKey: "AIzaSyAecwXgmT8rMGw1LpXKTS3xX-2YPcDlZZw", authDomain: "naruna-payroll.firebaseapp.com", projectId: "naruna-payroll", storageBucket: "naruna-payroll.firebasestorage.app", messagingSenderId: "209087490496", appId: "1:209087490496:web:f632b7a1cc3fa9166f4025" };
        
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const auth = firebase.auth(); 
        const db = firebase.firestore(); 
        const storage = firebase.storage();
        
        let masterKaryawanList = [];
        let selectedHeaderImg = null; // Menyimpan Base64 kop yang aktif

        // --- MANAJEMEN KOP SURAT ---
        
        function initHeaderSystem() {
            const savedHeaders = JSON.parse(localStorage.getItem('savedHeaders')) || [];
            const activeIndex = localStorage.getItem('activeHeaderIndex');
            renderHeaderGallery(savedHeaders, activeIndex);
            
            // Set active if exists
            if (activeIndex !== null && savedHeaders[activeIndex]) {
                selectedHeaderImg = savedHeaders[activeIndex];
                updateActivePreview(selectedHeaderImg);
            }
        }

        function handleHeaderUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                const savedHeaders = JSON.parse(localStorage.getItem('savedHeaders')) || [];
                savedHeaders.push(base64);
                localStorage.setItem('savedHeaders', JSON.stringify(savedHeaders));
                
                // Auto select new
                const newIndex = savedHeaders.length - 1;
                localStorage.setItem('activeHeaderIndex', newIndex);
                selectedHeaderImg = base64;
                
                renderHeaderGallery(savedHeaders, newIndex);
                updateActivePreview(base64);
                alert("Kop surat berhasil ditambahkan!");
            };
            reader.readAsDataURL(file);
        }

        function renderHeaderGallery(headers, activeIndex) {
            const gallery = document.getElementById('header-gallery');
            gallery.innerHTML = '';
            
            headers.forEach((imgSrc, idx) => {
                const isActive = idx == activeIndex;
                const div = document.createElement('div');
                div.className = `kop-item relative h-20 bg-slate-100 rounded cursor-pointer overflow-hidden ${isActive ? 'active' : ''}`;
                div.onclick = () => selectHeader(idx);
                div.innerHTML = `<img src="${imgSrc}" class="w-full h-full object-cover" />
                                 ${isActive ? '<div class="absolute bottom-0 right-0 bg-blue-600 text-white text-[10px] px-1 font-bold">AKTIF</div>' : ''}`;
                gallery.appendChild(div);
            });
        }

        function selectHeader(index) {
            const savedHeaders = JSON.parse(localStorage.getItem('savedHeaders')) || [];
            if (savedHeaders[index]) {
                localStorage.setItem('activeHeaderIndex', index);
                selectedHeaderImg = savedHeaders[index];
                renderHeaderGallery(savedHeaders, index);
                updateActivePreview(selectedHeaderImg);
            }
        }

        function updateActivePreview(src) {
            const preview = document.getElementById('active-header-preview');
            preview.innerHTML = `<img src="${src}" class="w-full h-auto" />`;
        }

        function clearHeaderGallery() {
            if(confirm("Hapus semua kop tersimpan?")) {
                localStorage.removeItem('savedHeaders');
                localStorage.removeItem('activeHeaderIndex');
                selectedHeaderImg = null;
                document.getElementById('header-gallery').innerHTML = '';
                document.getElementById('active-header-preview').innerHTML = '<span class="text-xs text-slate-400 italic">Belum ada kop dipilih</span>';
            }
        }

        // --- UTILITIES ---
        function log(msg, type='info') {
            const box = document.getElementById('console-body');
            const cl = type=='error'?'log-err':(type=='success'?'log-success':'');
            if(box.childElementCount > 50) box.removeChild(box.firstChild);
            box.innerHTML += `<div class="log-entry ${cl}"><span class="opacity-50">[${new Date().toLocaleTimeString()}]</span> ${typeof msg==='object'?JSON.stringify(msg):msg}</div>`;
            box.scrollTop = box.scrollHeight;
            if(type=='error') document.getElementById('debug-console').classList.add('open');
        }

        function toggleSection(id) {
            const el = document.getElementById(id);
            const icon = document.getElementById('icon-'+id);
            if(!el || !icon) return;
            if(el.classList.contains('hidden')) { el.classList.remove('hidden'); icon.style.transform = 'rotate(180deg)'; } 
            else { el.classList.add('hidden'); icon.style.transform = 'rotate(0deg)'; }
        }

        function toggleConsole() { document.getElementById('debug-console').classList.toggle('open'); }
        function showLoading(show, text="Processing...") {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
            document.getElementById('loading-text').innerText = text;
        }

        function cleanNum(raw) { 
            if(raw === null || raw === undefined || raw === '') return 0;
            if (typeof raw === 'number') return raw;
            let s = String(raw).trim();
            let isNegative = s.startsWith('-') || (s.startsWith('(') && s.endsWith(')'));
            s = s.replace(/[^0-9.,]/g, '');
            const hasDot = s.includes('.');
            const hasComma = s.includes(',');
            if (hasDot && hasComma) {
                if (s.lastIndexOf('.') > s.lastIndexOf(',')) s = s.replace(/,/g, '');
                else s = s.replace(/\./g, '').replace(',', '.');
            } else if (hasDot) {
                if ((s.match(/\./g) || []).length > 1) s = s.replace(/\./g, '');
                else { const parts = s.split('.'); if (parts[1].length === 3) s = s.replace(/\./g, ''); }
            } else if (hasComma) s = s.replace(',', '.');
            let val = parseFloat(s);
            if (isNaN(val)) return 0;
            return isNegative ? -val : val;
        }

        function isNameMatch(excelName, masterName) {
            const normalize = (str) => str.toLowerCase().replace(/[^a-z0-9\s]/g, '').trim();
            const n1 = normalize(excelName);
            const n2 = normalize(masterName);
            if (!n1 || !n2) return false;
            if (n1 === n2 || n1.includes(n2) || n2.includes(n1)) return true;
            const t1 = n1.split(/\s+/);
            const t2 = n2.split(/\s+/);
            let matches = 0;
            const minLen = Math.min(t1.length, t2.length);
            for (let t of t1) { if (t2.some(x => x.startsWith(t) || t.startsWith(x))) matches++; }
            return (matches / minLen) >= 0.75;
        }

        // --- AUTH & LOAD ---
        auth.onAuthStateChanged(u => {
            if(u) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('app-section').classList.remove('hidden');
                loadData();
                initHeaderSystem(); // Load Header System
                toggleSection('header-content'); // Buka menu kop by default
            } else {
                document.getElementById('login-section').classList.remove('hidden');
                document.getElementById('app-section').classList.add('hidden');
            }
        });
        function handleLogin(e){ e.preventDefault(); showLoading(true); auth.signInWithEmailAndPassword(document.getElementById('email').value,document.getElementById('password').value).catch(e=>{alert("Login Gagal");}).finally(()=>showLoading(false)); }

        function loadData() {
            db.collection('karyawan').onSnapshot(s => {
                masterKaryawanList = [];
                s.forEach(d => { masterKaryawanList.push(d.data()); });
                document.getElementById('master-count').innerText = masterKaryawanList.length;
            });
        }

        document.getElementById('master-excel-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if(!file) return;
            showLoading(true, "Updating Master...");
            const reader = new FileReader();
            reader.onload = async (evt) => {
                try {
                    const wb = XLSX.read(evt.target.result, {type:'binary'});
                    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    let batch = db.batch(); let count = 0; let successCount = 0;
                    for(let row of rows) {
                        const k = Object.keys(row);
                        const nm = k.find(x=>x.toUpperCase().includes('NAMA'));
                        const hp = k.find(x=>x.toUpperCase().includes('PHONE')||x.toUpperCase().includes('HP')||x.toUpperCase().includes('WA'));
                        if(nm && hp) {
                            const rawName = String(row[nm]).trim();
                            const rawWa = String(row[hp]).replace(/[^0-9]/g,'');
                            if(rawName.length < 3) continue; 
                            const id = rawName.toLowerCase().replace(/[^a-z0-9]/g, '');
                            const ref = db.collection('karyawan').doc(id);
                            batch.set(ref, { nama: rawName, wa: rawWa }, {merge: true});
                            count++; 
                            if(count >= 400){ await batch.commit(); successCount += count; batch = db.batch(); count = 0; }
                        }
                    }
                    if(count > 0) { await batch.commit(); successCount += count; }
                    alert(`Berhasil update ${successCount} kontak.`);
                    toggleSection('master-content');
                } catch(e) { alert("Gagal proses file"); }
                showLoading(false);
            };
            reader.readAsBinaryString(file);
        });

        // --- MAIN LOGIC ---
        document.getElementById('payroll-file').addEventListener('change', (e) => {
            const file = e.target.files[0]; if(!file) return;
            showLoading(true, "Menganalisa File...");
            document.getElementById('error-banner').classList.add('hidden');
            
            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    const wb = XLSX.read(evt.target.result, {type:'binary'});
                    const rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1, defval: ''});
                    let hIdx = -1;
                    for(let i=0; i<30; i++) { 
                        const rowStr = JSON.stringify(rawData[i]||[]).toUpperCase();
                        if(rowStr.includes("GAJI POKOK") && rowStr.includes("NAMA")) { hIdx = i; break; } 
                    }
                    if(hIdx === -1) throw new Error("Header tidak ditemukan.");

                    const header = rawData[hIdx].map(x => String(x).toUpperCase().trim());
                    const getCol = (keywords) => header.findIndex(h => keywords.some(k => h === k || h.includes(k)));

                    const col = {
                        nama: getCol(["NAMA", "NAMA KARYAWAN"]), nik: getCol(["NIK", "NO INDUK"]), outlet: getCol(["DIVISI", "BAGIAN", "OUTLET"]),
                        gp: getCol(["GAJI POKOK"]), tunj: getCol(["TUNJANGAN JABATAN", "TUNJANGAN"]), omset: getCol(["BONUS OMSET", "OMSET"]), 
                        kinerja: getCol(["BONUS KINERJA", "KINERJA"]), like: getCol(["LIKE KOMEN", "BONUS LIKE"]), lembur: getCol(["LEMBUR HARIAN"]), 
                        ot: getCol(["OVERTIME"]), kebijakan: getCol(["KEBIJAKAN"]), absen: getCol(["POTONGAN ABSEN"]), bpjs_kes: getCol(["BPJS KESEHATAN", "BPJS KES"]), 
                        bpjs_tk: getCol(["BPJS KETENAGAKERJAAN", "BPJS TK"]), weekend: getCol(["WEEKEND", "HARI BESAR"]), pot_jam: getCol(["POTONGAN JAM"]), 
                        thp_excel: getCol(["DITERIMA", "THP", "TOTAL GAJI"]) 
                    };

                    const tbody = document.getElementById('payroll-table-body');
                    tbody.innerHTML = '';
                    document.getElementById('payroll-result').classList.remove('hidden');
                    let processedCount = 0;
                    const dataRows = rawData.slice(hIdx+1);

                    dataRows.forEach((row, idx) => {
                        if(!row[col.nama]) return; 
                        const rawNama = String(row[col.nama]).trim();
                        if(rawNama.length < 2 || /TOTAL|SUBTOTAL/i.test(rawNama)) return;

                        const v = (idx) => (idx > -1) ? cleanNum(row[idx]) : 0;
                        let rawLembur = v(col.lembur), valLembur = rawLembur, countLembur = 0;
                        if(rawLembur > 0 && rawLembur <= 31) { valLembur = rawLembur * 40000; countLembur = rawLembur; }
                        let rawOT = v(col.ot), valOT = rawOT, countOT = 0;
                        if(rawOT > 0 && rawOT < 100) { valOT = rawOT * 5000; countOT = rawOT; }
                        let rawPotJam = v(col.pot_jam), valPotJam = rawPotJam, countPotJam = 0;
                        if(rawPotJam > 0 && rawPotJam < 100) { valPotJam = rawPotJam * 5000; countPotJam = rawPotJam; }
                        let rawAbsen = v(col.absen), valAbsen = rawAbsen, countAbsen = 0;
                        // Asumsi potongan absen
                        if(rawAbsen > 0 && rawAbsen < 31) { countAbsen = rawAbsen; valAbsen = rawAbsen * 72000; } // Default rate jika terdeteksi hari

                        const inc = { gp: v(col.gp), tunj: v(col.tunj), omset: v(col.omset), kinerja: v(col.kinerja), like: v(col.like), lembur: valLembur, ot: valOT, kebijakan: v(col.kebijakan) };
                        const ded = { absen: valAbsen, bpjs_kes: v(col.bpjs_kes), bpjs_tk: v(col.bpjs_tk), weekend: v(col.weekend), pot_jam: valPotJam };
                        const total_in = Math.round(Object.values(inc).reduce((a,b)=>a+b, 0));
                        const total_out = Math.round(Object.values(ded).reduce((a,b)=>a+b, 0));
                        const thp_system = total_in - total_out;

                        const matched = masterKaryawanList.find(m => isNameMatch(rawNama, m.nama));
                        const wa = matched ? matched.wa : null;
                        const d = { NIK: row[col.nik]||'-', NAMA: rawNama, DIVISI: row[col.outlet]||'STAFF', COUNTS: { lembur: countLembur, ot: countOT, pot_jam: countPotJam, absen: countAbsen }, INCOME: inc, DEDUCT: ded, TOTAL_IN: total_in, TOTAL_OUT: total_out, THP: thp_system };
                        const fmt = n => Number(n).toLocaleString('id-ID');
                        
                        tbody.innerHTML += `<tr class="border-b hover:bg-slate-50">
                            <td class="p-3">${wa?'<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">MATCH</span>':'<span class="bg-red-100 text-red-600 px-2 py-1 rounded text-xs font-bold">NO HP</span>'}</td>
                            <td class="p-3"><div class="font-bold text-slate-700 text-sm">${d.NAMA}</div><div class="text-[10px] text-slate-400">${d.NIK}</div></td>
                            <td class="p-3 text-right text-green-700 text-xs font-mono">${fmt(d.TOTAL_IN)}</td>
                            <td class="p-3 text-right text-red-600 text-xs font-mono">(${fmt(d.TOTAL_OUT)})</td>
                            <td class="p-3 text-right"><div class="font-bold text-blue-800 text-sm">${fmt(d.THP)}</div></td>
                            <td class="p-3 text-center sticky right-0 bg-white z-10">${wa?`<button id="btn-${idx}" onclick='uploadAndSend(this, ${JSON.stringify(d)},"${wa}")' class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg shadow-md text-xs font-bold transition flex items-center gap-1 mx-auto"><i class="fab fa-whatsapp"></i> KIRIM</button>`:'-'}</td>
                        </tr>`;
                        processedCount++;
                    });
                    document.getElementById('process-count-badge').innerText = processedCount + " Karyawan";
                } catch(err) { alert("Error: " + err.message); }
                showLoading(false);
            };
            reader.readAsBinaryString(file);
        });

        // --- RENDER & SEND ---
        async function uploadAndSend(btn, data, waNumber) {
            if(!selectedHeaderImg) {
                alert("Harap pilih Kop Surat terlebih dahulu di menu Pengaturan Kop Surat (Bagian 1).");
                return;
            }

            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Loading`;
            btn.disabled = true;
            
            showLoading(true, `Menyiapkan slip ${data.NAMA}...`);
            let formattedWa = String(waNumber).replace(/[^0-9]/g, '');
            if (formattedWa.startsWith('0')) formattedWa = '62' + formattedWa.slice(1);

            try {
                const area = document.getElementById('render-area');
                const fmt = n => Number(n).toLocaleString('id-ID');
                const tglCetak = new Date().toLocaleDateString('id-ID', {day: '2-digit', month: 'long', year: 'numeric'});
                const periodeBulan = new Date().toLocaleDateString('id-ID', {month: 'long'}).toUpperCase();
                
                // --- TEMPLATE BARU (SESUAI GAMBAR) ---
                area.innerHTML = `
                <div class="payslip-container" style="background:white; padding-bottom: 20px;">
                    <div style="width:100%; margin-bottom: 0px;">
                        <img src="${selectedHeaderImg}" style="width:100%; height:auto; display:block;">
                    </div>

                    <div style="text-align:center; margin: 15px 0;">
                        <h2 style="font-weight:bold; font-size:18px; margin:0; text-decoration: underline;">SLIP GAJI</h2>
                    </div>

                    <div style="padding: 0 40px; margin-bottom: 15px;">
                        <table style="width:100%; font-size: 14px; border-collapse: collapse;">
                            <tr>
                                <td style="width: 100px; padding: 2px 0;">NIK</td>
                                <td style="width: 10px;">:</td>
                                <td style="font-weight: bold;">${data.NIK}</td>
                            </tr>
                            <tr>
                                <td style="padding: 2px 0;">NAMA</td>
                                <td>:</td>
                                <td style="font-weight: bold; text-transform: uppercase;">${data.NAMA}</td>
                            </tr>
                            <tr>
                                <td style="padding: 2px 0;">DIVISI</td>
                                <td>:</td>
                                <td style="font-weight: bold; text-transform: uppercase;">${data.DIVISI}</td>
                            </tr>
                            <tr>
                                <td style="padding: 2px 0;">PERIODE</td>
                                <td>:</td>
                                <td style="font-weight: bold; text-transform: uppercase;">${periodeBulan}</td>
                            </tr>
                            <tr>
                                <td style="padding: 2px 0;">HARI KERJA</td>
                                <td>:</td>
                                <td style="font-weight: bold;">25</td>
                            </tr>
                        </table>
                    </div>

                    <div style="padding: 0 40px;">
                        <table style="width:100%; font-size: 14px; border-collapse: collapse;">
                            <tr>
                                <td style="padding: 4px 0;">GAJI POKOK</td>
                                <td style="text-align:center;"></td>
                                <td style="width: 20px;">:</td>
                                <td style="width: 30px;">Rp</td>
                                <td style="text-align:right;">${fmt(data.INCOME.gp)}</td>
                            </tr>
                            ${data.INCOME.ot > 0 ? `
                            <tr>
                                <td style="padding: 4px 0;">OVERTIME MALAM</td>
                                <td style="text-align:center;">${data.COUNTS.ot} JAM</td>
                                <td>:</td>
                                <td>Rp</td>
                                <td style="text-align:right;">${fmt(data.INCOME.ot)}</td>
                            </tr>` : ''}
                            ${data.INCOME.lembur > 0 ? `
                            <tr>
                                <td style="padding: 4px 0;">LEMBUR HARIAN</td>
                                <td style="text-align:center;">${data.COUNTS.lembur} HARI</td>
                                <td>:</td>
                                <td>Rp</td>
                                <td style="text-align:right;">${fmt(data.INCOME.lembur)}</td>
                            </tr>` : ''}
                            ${data.INCOME.kebijakan > 0 ? `
                            <tr>
                                <td style="padding: 4px 0;">KEBIJAKAN KINERJA</td>
                                <td></td>
                                <td>:</td>
                                <td>Rp</td>
                                <td style="text-align:right;">${fmt(data.INCOME.kebijakan)}</td>
                            </tr>` : ''}
                            ${data.INCOME.omset > 0 ? `
                            <tr>
                                <td style="padding: 4px 0;">BONUS OMSET</td>
                                <td></td>
                                <td>:</td>
                                <td>Rp</td>
                                <td style="text-align:right;">${fmt(data.INCOME.omset)}</td>
                            </tr>` : ''}
                            ${data.INCOME.kinerja > 0 ? `
                            <tr>
                                <td style="padding: 4px 0;">BONUS KINERJA</td>
                                <td></td>
                                <td>:</td>
                                <td>Rp</td>
                                <td style="text-align:right;">${fmt(data.INCOME.kinerja)}</td>
                            </tr>` : ''}
                            ${data.INCOME.like > 0 ? `
                            <tr>
                                <td style="padding: 4px 0;">BONUS LIKE KOMENT</td>
                                <td></td>
                                <td>:</td>
                                <td>Rp</td>
                                <td style="text-align:right;">${fmt(data.INCOME.like)}</td>
                            </tr>` : ''}
                            ${data.INCOME.tunj > 0 ? `
                            <tr>
                                <td style="padding: 4px 0;">TUNJANGAN JABATAN</td>
                                <td></td>
                                <td>:</td>
                                <td>Rp</td>
                                <td style="text-align:right;">${fmt(data.INCOME.tunj)}</td>
                            </tr>` : ''}

                            <tr style="font-weight: bold;">
                                <td style="padding: 15px 0 5px 0;">GAJI KOTOR</td>
                                <td></td>
                                <td style="padding-top:10px;">:</td>
                                <td style="padding-top:10px;">Rp</td>
                                <td style="text-align:right; padding-top:10px;">${fmt(data.TOTAL_IN)}</td>
                            </tr>
                            <tr><td colspan="5" style="border-bottom: 1px solid #000;"></td></tr>
                            <tr><td colspan="5" style="height: 10px;"></td></tr>

                            ${data.DEDUCT.absen > 0 ? `
                            <tr>
                                <td style="padding: 4px 0;">POTONGAN ABSEN</td>
                                <td style="text-align:center;">${data.COUNTS.absen || 1} HARI</td>
                                <td>:</td>
                                <td>Rp</td>
                                <td style="text-align:right;">${fmt(data.DEDUCT.absen)}</td>
                            </tr>` : ''}
                            ${data.DEDUCT.weekend > 0 ? `
                            <tr>
                                <td style="padding: 4px 0;">POTONGAN HARI BESAR/WEEKEND</td>
                                <td></td>
                                <td>:</td>
                                <td>Rp</td>
                                <td style="text-align:right;">${fmt(data.DEDUCT.weekend)}</td>
                            </tr>` : ''}
                            ${data.DEDUCT.pot_jam > 0 ? `
                            <tr>
                                <td style="padding: 4px 0;">POTONGAN JAM</td>
                                <td style="text-align:center;">${data.COUNTS.pot_jam} JAM</td>
                                <td>:</td>
                                <td>Rp</td>
                                <td style="text-align:right;">${fmt(data.DEDUCT.pot_jam)}</td>
                            </tr>` : ''}
                            ${data.DEDUCT.bpjs_kes > 0 ? `
                            <tr>
                                <td style="padding: 4px 0;">POTONGAN BPJS KESEHATAN</td>
                                <td></td>
                                <td>:</td>
                                <td>Rp</td>
                                <td style="text-align:right;">${fmt(data.DEDUCT.bpjs_kes)}</td>
                            </tr>` : ''}
                            ${data.DEDUCT.bpjs_tk > 0 ? `
                            <tr>
                                <td style="padding: 4px 0;">POTONGAN BPJS KETENAGAKERJAAN</td>
                                <td></td>
                                <td>:</td>
                                <td>Rp</td>
                                <td style="text-align:right;">${fmt(data.DEDUCT.bpjs_tk)}</td>
                            </tr>` : ''}

                            <tr><td colspan="5" style="height: 10px; border-bottom: 2px solid #000;"></td></tr>
                            
                            <tr style="font-weight: bold; background-color: #ffff00;">
                                <td style="padding: 8px 0 8px 5px;">GAJI BERSIH</td>
                                <td></td>
                                <td>:</td>
                                <td>Rp</td>
                                <td style="text-align:right; padding-right:5px;">${fmt(data.THP)}</td>
                            </tr>
                            <tr><td colspan="5" style="border-top: 2px solid #000;"></td></tr>
                        </table>
                    </div>

                    <div style="margin-top: 30px; display: flex; justify-content: flex-end; padding-right: 40px; font-size: 14px;">
                        <div style="text-align: center;">
                            <p>Salatiga, ${tglCetak}</p>
                            <br><br><br><br>
                            <p style="font-weight: bold; text-decoration: underline;">RYAN INDRA SETYAWAN</p>
                        </div>
                    </div>
                </div>`;

                // --- GENERATE IMAGE ---
                const canvas = await html2canvas(area.querySelector('.payslip-container'), {scale: 1.5, useCORS: true});
                canvas.toBlob(async (blob) => {
                    const fname = `slip_${data.NAMA.replace(/\s/g,'_')}_${Date.now()}.jpg`;
                    const snap = await storage.ref().child('slips/'+fname).put(blob);
                    const url = await snap.ref.getDownloadURL();
                    const msg = `Halo ${data.NAMA},\nBerikut Slip Gaji periode ini.\n\n*Total Diterima: Rp ${fmt(data.THP)}*\n\nUnduh Slip: ${url}`;
                    window.open(`https://wa.me/${formattedWa}?text=${encodeURIComponent(msg)}`, '_blank');
                    
                    btn.innerHTML = `<i class="fas fa-check"></i> Terkirim`;
                    btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    btn.classList.add('bg-green-600', 'hover:bg-green-700');
                    btn.disabled = false;
                    showLoading(false);
                }, 'image/jpeg', 0.85);

            } catch(e) { 
                alert("Gagal kirim: "+e.message); 
                btn.innerHTML = originalText;
                btn.disabled = false;
                showLoading(false); 
            }
        }
    </script>
</body>
</html>
