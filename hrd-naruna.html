<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dolan Payroll - V7 (Smart Diagnostic)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script>tailwind.config = { theme: { extend: { colors: { primary: '#1e3a8a' }, fontFamily: { sans: ['Inter'] } } } }</script>
    <style>
        body { background: #f1f5f9; font-family: 'Inter', sans-serif; }
        .payslip-container { width: 800px; background: white; padding: 40px; border: 1px solid #cbd5e1; }
        .payslip-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .payslip-table td { padding: 4px 8px; vertical-align: top; }
        .val-col { text-align: right; font-weight: bold; }
        .total-row { background-color: #fef08a; font-weight: 800; border-top: 2px solid #000; }
        
        /* DIAGNOSTIC PANEL */
        #diagnostic-panel {
            position: fixed; bottom: 20px; right: 20px; width: 350px; 
            background: #1e293b; color: #4ade80; border-radius: 10px; 
            font-family: 'Courier New', monospace; font-size: 11px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); z-index: 9999;
            display: flex; flex-direction: column; overflow: hidden;
            border: 1px solid #334155;
        }
        #log-content { height: 150px; overflow-y: auto; padding: 10px; border-bottom: 1px solid #334155; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #334155; padding-bottom: 2px; }
        .log-err { color: #f87171; font-weight: bold; }
        .log-warn { color: #fbbf24; }
        .log-success { color: #4ade80; }
        .log-info { color: #94a3b8; }
    </style>
</head>
<body>
    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2"></div>

    <div id="diagnostic-panel">
        <div class="bg-slate-900 p-2 font-bold text-gray-400 flex justify-between items-center text-xs">
            <span><i class="fas fa-bug"></i> SYSTEM MONITOR</span>
            <button onclick="clearLog()" class="hover:text-white">Clear</button>
        </div>
        <div id="log-content">
            <div class="log-info">System Ready...</div>
        </div>
        <div class="p-2 bg-slate-800">
            <button onclick="copyReport()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded text-xs font-bold">
                <i class="fas fa-copy"></i> COPY LAPORAN UNTUK DEVELOPER
            </button>
        </div>
    </div>

    <div id="login-section" class="min-h-screen flex items-center justify-center bg-slate-800">
        <div class="bg-white p-8 rounded-xl w-96 shadow-2xl">
            <h2 class="text-2xl font-bold mb-6 text-center text-slate-700">Dolan Admin V7</h2>
            <form onsubmit="handleLogin(event)">
                <input id="email" class="w-full border p-3 rounded mb-3" placeholder="Email" required>
                <input type="password" id="password" class="w-full border p-3 rounded mb-6" placeholder="Password" required>
                <button class="w-full bg-blue-600 text-white p-3 rounded font-bold hover:bg-blue-700">LOGIN</button>
            </form>
        </div>
    </div>

    <div id="app-section" class="hidden min-h-screen flex flex-col">
        <nav class="bg-white border-b h-16 px-6 flex justify-between items-center shadow-sm sticky top-0 z-40">
            <div class="font-bold text-lg text-slate-700"><i class="fas fa-chart-line text-blue-600"></i> Dolan<span class="text-blue-600">Payroll</span> Diagnostic</div>
            <div class="flex gap-2 text-sm">
                <button onclick="switchTab('payroll')" class="px-3 py-2 bg-blue-600 text-white rounded shadow">Gaji</button>
                <button onclick="switchTab('karyawan')" class="px-3 py-2 bg-white border hover:bg-gray-50 rounded">Data Master</button>
                <button onclick="switchTab('outlet')" class="px-3 py-2 bg-white border hover:bg-gray-50 rounded">Outlet</button>
                <button onclick="auth.signOut()" class="text-red-500 px-2"><i class="fas fa-power-off"></i></button>
            </div>
        </nav>

        <main class="p-6 max-w-6xl mx-auto w-full mb-32">
            
            <div id="tab-karyawan" class="tab-content hidden">
                <div class="bg-white p-6 rounded-lg shadow border mb-6">
                    <h2 class="font-bold text-lg mb-2">Sync Kontak HP</h2>
                    <div class="flex gap-3 mb-4">
                        <label class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded cursor-pointer text-sm font-bold flex items-center shadow">
                            <i class="fas fa-file-excel mr-2"></i> Upload File HP
                            <input type="file" id="master-excel-upload" accept=".xlsx,.xls" class="hidden">
                        </label>
                        <button onclick="openModal('modal-karyawan')" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded text-sm">Input Manual</button>
                    </div>
                    <div class="overflow-x-auto border rounded">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 text-gray-600 font-bold"><tr><th class="p-3">NIK</th><th class="p-3">Nama</th><th class="p-3">WhatsApp</th><th class="p-3">Aksi</th></tr></thead>
                            <tbody id="table-karyawan-body" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-outlet" class="tab-content hidden">
                <div class="flex justify-between mb-4"><h2 class="font-bold text-lg">Data Outlet</h2><button onclick="openModal('modal-outlet')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">Tambah</button></div>
                <div id="outlet-grid" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            </div>

            <div id="tab-payroll" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow border mb-6">
                    <h2 class="font-bold text-lg mb-2">Upload Gaji Bulanan</h2>
                    <p class="text-sm text-gray-500 mb-4">Pastikan file memiliki kolom NIK. Sistem akan mencari header otomatis.</p>
                    
                    <label class="border-2 border-dashed border-blue-300 bg-blue-50 hover:bg-blue-100 p-8 rounded-lg cursor-pointer flex flex-col items-center justify-center text-blue-700 transition mb-6">
                        <i class="fas fa-cloud-upload-alt text-3xl mb-2"></i>
                        <span class="font-bold">Klik Upload File Gaji (.xlsx)</span>
                        <input type="file" id="payroll-file" accept=".xlsx,.xls" class="hidden">
                    </label>

                    <div id="payroll-result" class="hidden">
                        <h3 class="font-bold text-gray-700 mb-2 border-b pb-2">Hasil Pembacaan</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-2">Status</th><th class="p-2">NIK</th><th class="p-2">Nama</th><th class="p-2">Outlet</th><th class="p-2 text-right">THP</th><th class="p-2">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="payroll-table-body" class="divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-karyawan" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50"><div class="bg-white p-6 rounded w-80"><h3 class="font-bold mb-3">Input Karyawan</h3><input id="in-nik" placeholder="NIK" class="w-full border p-2 mb-2"><input id="in-nama" placeholder="Nama" class="w-full border p-2 mb-2"><input id="in-wa" placeholder="No WA" class="w-full border p-2 mb-4"><div class="flex gap-2"><button onclick="closeModal('modal-karyawan')" class="flex-1 bg-gray-200 p-2">Batal</button><button onclick="saveKaryawanManual()" class="flex-1 bg-blue-600 text-white p-2">Simpan</button></div></div></div>
    <div id="modal-outlet" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50"><div class="bg-white p-6 rounded w-80"><h3 class="font-bold mb-3">Tambah Outlet</h3><input id="in-outlet" placeholder="Nama" class="w-full border p-2 mb-2"><textarea id="in-addr" placeholder="Alamat" class="w-full border p-2 mb-2"></textarea><input type="file" id="in-logo" class="w-full text-xs mb-4"><div class="flex gap-2"><button onclick="closeModal('modal-outlet')" class="flex-1 bg-gray-200 p-2">Batal</button><button onclick="saveOutlet()" class="flex-1 bg-blue-600 text-white p-2">Simpan</button></div></div></div>
    <div id="render-area" class="absolute left-[-9999px]"></div>

    <script>
        // --- 0. SMART LOGGER ENGINE ---
        let systemLogData = [];
        
        function log(msg, type='info') {
            const timestamp = new Date().toLocaleTimeString();
            systemLogData.push(`[${timestamp}] [${type.toUpperCase()}] ${msg}`);
            
            const box = document.getElementById('log-content');
            const cssClass = type === 'error' ? 'log-err' : (type === 'success' ? 'log-success' : (type==='warn'?'log-warn':'log-info'));
            
            const div = document.createElement('div');
            div.className = `log-entry ${cssClass}`;
            div.innerHTML = `[${timestamp}] ${msg}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function clearLog() {
            systemLogData = [];
            document.getElementById('log-content').innerHTML = '';
            log("Log dibersihkan.", "info");
        }

        function copyReport() {
            const report = "=== LAPORAN DIAGNOSTIK DOLAN PAYROLL ===\n\n" + systemLogData.join('\n') + "\n\n=== END REPORT ===";
            navigator.clipboard.writeText(report).then(() => {
                alert("Laporan tersalin! Silakan Paste (Ctrl+V) ke WhatsApp developer.");
            });
        }

        // --- 1. CONFIG ---
        const firebaseConfig = { apiKey: "AIzaSyAecwXgmT8rMGw1LpXKTS3xX-2YPcDlZZw", authDomain: "naruna-payroll.firebaseapp.com", projectId: "naruna-payroll", storageBucket: "naruna-payroll.firebasestorage.app", messagingSenderId: "209087490496", appId: "1:209087490496:web:f632b7a1cc3fa9166f4025" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); const db = firebase.firestore(); const storage = firebase.storage();
        let masterKaryawan = {}; let masterOutlet = {};

        // --- 2. HELPERS ---
        function cleanStr(s) { return String(s||'').toLowerCase().replace(/[^a-z0-9]/g, ''); }
        function cleanPhone(p) { let s=String(p||'').replace(/[^0-9]/g,''); if(s.startsWith('08')) s='62'+s.slice(1); if(s.startsWith('8')) s='62'+s; return s; }
        function cleanNum(n) { if(!n) return 0; let s=String(n).replace(/Rp\.?/gi,'').replace(/\./g,'').replace(/,/g,'.').trim(); return parseInt(s)||0; }

        // --- 3. AUTH & LOAD ---
        auth.onAuthStateChanged(u => {
            if(u) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('app-section').classList.remove('hidden');
                log(`Login berhasil sebagai ${u.email}`, "success");
                loadData();
            } else {
                document.getElementById('login-section').classList.remove('hidden');
                document.getElementById('app-section').classList.add('hidden');
            }
        });
        function handleLogin(e){ e.preventDefault(); auth.signInWithEmailAndPassword(document.getElementById('email').value,document.getElementById('password').value).catch(e=>log("Login Gagal: "+e.message, "error")); }

        function loadData() {
            db.collection('karyawan').onSnapshot(s => {
                const b = document.getElementById('table-karyawan-body'); b.innerHTML=''; masterKaryawan={};
                s.forEach(d => { const dt = d.data(); masterKaryawan[cleanStr(dt.nik)] = { ...dt, id: d.id }; b.innerHTML+=`<tr class="border-b"><td class="p-3">${dt.nik}</td><td class="p-3 font-bold">${dt.nama}</td><td class="p-3 text-blue-600">${dt.wa||'-'}</td><td class="p-3"><button onclick="db.collection('karyawan').doc('${d.id}').delete()" class="text-red-500"><i class="fas fa-trash"></i></button></td></tr>`; });
                log(`Database: ${s.size} karyawan termuat.`, "info");
            });
            db.collection('outlets').onSnapshot(s => {
                const g = document.getElementById('outlet-grid'); g.innerHTML=''; masterOutlet={};
                s.forEach(d => { const dt = d.data(); masterOutlet[dt.nama.toLowerCase()] = dt; g.innerHTML+=`<div class="bg-white p-3 border rounded shadow flex flex-col items-center relative"><img src="${dt.logoUrl}" class="h-8 mb-2"><div class="font-bold text-xs">${dt.nama}</div><button onclick="db.collection('outlets').doc('${d.id}').delete()" class="absolute top-1 right-1 text-red-300"><i class="fas fa-trash"></i></button></div>`; });
            });
        }

        // --- 4. SMART SYNC HP ---
        document.getElementById('master-excel-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if(!file) return;
            log(`Mulai membaca file HP: ${file.name}`, "info");
            
            const reader = new FileReader();
            reader.onload = async (evt) => {
                try {
                    const wb = XLSX.read(evt.target.result, {type:'binary'});
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(ws);
                    
                    if(rows.length === 0) throw new Error("File Excel Kosong!");
                    log(`Ditemukan ${rows.length} baris data. Mencari kolom Nama & HP...`, "info");

                    // Diagnostic Header
                    const headers = Object.keys(rows[0]);
                    log(`Header terdeteksi: [${headers.join(', ')}]`, "info");

                    let batch = db.batch(); let count=0; let matched=0;
                    const allEmps = Object.values(masterKaryawan);

                    for(let row of rows) {
                        const keys = Object.keys(row);
                        const nameKey = keys.find(k => k.toLowerCase().includes('nama'));
                        const phoneKey = keys.find(k => k.toLowerCase().includes('hp') || k.toLowerCase().includes('telp') || k.toLowerCase().includes('wa') || k.toLowerCase().includes('phone'));

                        if(!nameKey || !phoneKey) continue; // Skip jika kolom tak jelas

                        const rawName = String(row[nameKey]);
                        const rawPhone = cleanPhone(row[phoneKey]);
                        if(!rawPhone) continue;

                        // Fuzzy Matching Logic
                        let matchID = null;
                        const sName = cleanStr(rawName);
                        
                        // Cek 1: NAMA SAMA PERSIS (Normalized)
                        for (let emp of allEmps) {
                            const dbName = cleanStr(emp.nama);
                            // Cek exact atau partial strong
                            if (dbName === sName || dbName.includes(sName) || sName.includes(dbName)) {
                                matchID = emp.id;
                                break;
                            }
                        }

                        if(matchID) {
                            batch.update(db.collection('karyawan').doc(matchID), { wa: rawPhone });
                            count++; matched++;
                            // log(`Matched: ${rawName} -> ${rawPhone}`, "success"); // Terlalu spam
                        }
                        
                        if(count >= 400) { await batch.commit(); batch = db.batch(); count=0; }
                    }
                    if(count > 0) await batch.commit();
                    
                    log(`Sinkronisasi Selesai. ${matched} data terupdate dari ${rows.length} baris.`, matched>0?"success":"warn");
                    if(matched===0) log("PERINGATAN: Tidak ada data yang cocok. Cek apakah ejaan nama di Excel HP sama dengan di Gaji.", "warn");

                } catch(err) {
                    log("ERROR SYNC: " + err.message, "error");
                }
            };
            reader.readAsBinaryString(file);
        });

        // --- 5. PAYROLL ENGINE (AUTO HEADER) ---
        document.getElementById('payroll-file').addEventListener('change', (e) => {
            const file = e.target.files[0];
            log(`Mulai proses gaji: ${file.name}`, "info");
            
            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    const wb = XLSX.read(evt.target.result, {type:'binary'});
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const rawData = XLSX.utils.sheet_to_json(ws, {header: 1});

                    // 1. CARI HEADER ROW
                    let headerRowIdx = -1;
                    for(let i=0; i<Math.min(20, rawData.length); i++) { // Cari di 20 baris pertama
                        const str = JSON.stringify(rawData[i]).toUpperCase();
                        if(str.includes("NIK") && str.includes("NAMA")) {
                            headerRowIdx = i;
                            log(`Header ditemukan di Baris Excel ke-${i+1}`, "success");
                            break;
                        }
                    }

                    if(headerRowIdx === -1) {
                        throw new Error("Tidak menemukan kolom 'NIK' dan 'NAMA' di 20 baris pertama. Cek format Excel.");
                    }

                    const headerRow = rawData[headerRowIdx];
                    // Mapping Index Kolom (Relatif terhadap NIK)
                    let nikIdx = -1;
                    headerRow.forEach((h, idx) => { if(String(h).toUpperCase().includes("NIK")) nikIdx = idx; });
                    
                    if(nikIdx === -1) throw new Error("Kolom NIK hilang.");
                    
                    // Log Kolom Penting
                    log(`Mapping Kolom: NIK pada index ${nikIdx}, Nama ${nikIdx+1}, GP ${nikIdx+4}`, "info");

                    const tbody = document.getElementById('payroll-table-body');
                    tbody.innerHTML = '';
                    document.getElementById('payroll-result').classList.remove('hidden');

                    let processedCount = 0;
                    const dataRows = rawData.slice(headerRowIdx+1);
                    
                    dataRows.forEach((row, idx) => {
                        const nik = row[nikIdx] ? String(row[nikIdx]).trim() : '';
                        if(!nik) return;

                        // Gunakan RELATIVE INDEXING dari "CONTOH GAJI" user
                        // Asumsi: NIK(0), Nama(1), Outlet(2), Jabatan(3), GP(4)...
                        const i = nikIdx;
                        const d = {
                            NIK: nik,
                            NAMA: row[i+1],
                            OUTLET: row[i+2],
                            JABATAN: row[i+3],
                            GP: cleanNum(row[i+4]),
                            LEMBUR: cleanNum(row[i+6]) + cleanNum(row[i+8]),
                            BONUS: cleanNum(row[i+9]) + cleanNum(row[i+10]) + cleanNum(row[i+11]),
                            POT_ABSEN: cleanNum(row[i+14]),
                            BPJS: cleanNum(row[i+15]) + cleanNum(row[i+16]),
                            CASBON: cleanNum(row[i+17]),
                            TOTAL: cleanNum(row[i+19])
                        };

                        const emp = masterKaryawan[cleanStr(nik)];
                        const wa = emp ? emp.wa : null;

                        tbody.innerHTML += `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="p-2">${wa?'<span class="text-green-600 font-bold">OK</span>':'<span class="text-red-500 font-bold">X</span>'}</td>
                                <td class="p-2 text-xs font-mono">${d.NIK}</td>
                                <td class="p-2 font-bold text-gray-700">${d.NAMA||'?'}</td>
                                <td class="p-2 text-xs">${d.OUTLET||'-'}</td>
                                <td class="p-2 text-right font-mono">Rp ${d.TOTAL.toLocaleString('id-ID')}</td>
                                <td class="p-2 text-center">${wa ? `<button onclick='genSlip(${JSON.stringify(d)},"${wa}")' class="bg-green-600 text-white px-2 py-1 rounded text-xs">Kirim</button>` : ''}</td>
                            </tr>
                        `;
                        processedCount++;
                    });

                    log(`Berhasil memproses ${processedCount} baris gaji.`, "success");

                } catch(err) {
                    log("FATAL ERROR GAJI: " + err.message, "error");
                    alert("Gagal Proses: " + err.message);
                }
            };
            reader.readAsBinaryString(file);
        });

        // --- 6. GENERATE SLIP ---
        async function genSlip(data, wa) {
            log(`Generating slip untuk ${data.NAMA}...`, "info");
            const area = document.getElementById('render-area');
            const outletInfo = masterOutlet[(data.OUTLET||'').toLowerCase()] || {nama: data.OUTLET||'Outlet', logoUrl: '', alamat: ''};
            const fmt = n => 'Rp ' + Number(n).toLocaleString('id-ID');

            area.innerHTML = `
            <div class="payslip-container">
                <div class="payslip-header">
                    ${outletInfo.logoUrl ? `<img src="${outletInfo.logoUrl}" class="payslip-logo" crossorigin="anonymous">` : ''}
                    <div><h1 class="text-xl font-bold uppercase">${outletInfo.nama}</h1><p class="text-sm">${outletInfo.alamat||''}</p></div>
                </div>
                <h2 class="text-center font-bold text-lg border-b pb-2 mb-4">SLIP GAJI</h2>
                <table class="payslip-table mb-4">
                    <tr><td width="150">NIK</td><td>: ${data.NIK}</td></tr>
                    <tr><td>NAMA</td><td>: ${data.NAMA}</td></tr>
                    <tr><td>JABATAN</td><td>: ${data.JABATAN}</td></tr>
                </table>
                <table class="payslip-table">
                    <tr><td>GAJI POKOK</td><td>:</td><td class="val-col">${fmt(data.GP)}</td></tr>
                    <tr><td>LEMBUR</td><td>:</td><td class="val-col">${fmt(data.LEMBUR)}</td></tr>
                    <tr><td>TOTAL BONUS</td><td>:</td><td class="val-col">${fmt(data.BONUS)}</td></tr>
                    <tr><td colspan="3" class="h-4"></td></tr>
                    <tr><td>POT. ABSEN</td><td>:</td><td class="val-col text-red-600">${fmt(data.POT_ABSEN)}</td></tr>
                    <tr><td>BPJS</td><td>:</td><td class="val-col text-red-600">${fmt(data.BPJS)}</td></tr>
                    <tr><td>CASBON</td><td>:</td><td class="val-col text-red-600">${fmt(data.CASBON)}</td></tr>
                    <tr class="total-row"><td class="p-2">DITERIMA</td><td class="p-2">:</td><td class="val-col p-2">${fmt(data.TOTAL)}</td></tr>
                </table>
                <div class="mt-8 text-right mr-8">
                    <div class="mb-12">Salatiga, ${new Date().toLocaleDateString('id-ID')}</div>
                    <div class="font-bold underline">${data.NAMA}</div>
                </div>
            </div>`;

            // Wait Image
            const img = area.querySelector('img');
            if(img && img.src) await new Promise(r => { if(img.complete) r(); else img.onload = r; setTimeout(r, 2000); });

            try {
                const canvas = await html2canvas(area.querySelector('.payslip-container'), {scale:2, useCORS:true});
                const link = document.createElement('a');
                link.download = `Slip_${String(data.NAMA).replace(/\s/g,'_')}.jpg`;
                link.href = canvas.toDataURL("image/jpeg", 0.9);
                link.click();
                
                log(`Slip ${data.NAMA} berhasil dibuat & didownload.`, "success");
                window.open(`https://wa.me/${wa}?text=${encodeURIComponent('Halo, berikut slip gaji periode ini.')}`, '_blank');
            } catch(e) {
                log("Gagal membuat gambar slip: " + e.message, "error");
            }
        }

        // Utils
        function switchTab(id) { document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); document.getElementById('tab-'+id).classList.remove('hidden'); }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function saveKaryawanManual() { const n=document.getElementById('in-nik').value, nm=document.getElementById('in-nama').value, w=document.getElementById('in-wa').value; if(n&&nm) db.collection('karyawan').doc(cleanStr(n)).set({nik:n, nama:nm, wa:cleanPhone(w)}).then(()=>{closeModal('modal-karyawan');log("Karyawan manual disimpan.", "success");}); }
        function saveOutlet() { const n=document.getElementById('in-outlet').value, f=document.getElementById('in-logo').files[0]; if(n&&f) storage.ref('logos/'+Date.now()).put(f).then(s=>s.ref.getDownloadURL()).then(u=>db.collection('outlets').add({nama:n, alamat:document.getElementById('in-addr').value, logoUrl:u})).then(()=>{closeModal('modal-outlet');log("Outlet disimpan.", "success");}); }
    </script>
</body>
</html>
